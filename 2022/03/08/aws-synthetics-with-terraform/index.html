<!doctype html><html lang=en><head><title>AWS Synthetics With Terraform. Problems? :: Maksym Postument</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Which problems i faced when worked with aws_synthetics_canary terraform resource and how i solved them"><meta name=keywords content="Devops,AWS,Terraform,Synthetics"><meta name=robots content="noodp"><link rel=canonical href=https://mpostument.com/2022/03/08/aws-synthetics-with-terraform/><script async src="https://www.googletagmanager.com/gtag/js?id=G-SBRJXS94DC"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SBRJXS94DC",{anonymize_ip:!1})}</script><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=https://mpostument.com/img/theme-colors/blue.png><link rel=apple-touch-icon href=https://mpostument.com/img/theme-colors/blue.png><meta name=twitter:card content="summary"><meta name=twitter:site content="mpostument.com"><meta name=twitter:creator content="Maks_Postument"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="AWS Synthetics With Terraform. Problems?"><meta property="og:description" content="Which problems i faced when worked with aws_synthetics_canary terraform resource and how i solved them"><meta property="og:url" content="https://mpostument.com/2022/03/08/aws-synthetics-with-terraform/"><meta property="og:site_name" content="Maksym Postument"><meta property="og:image" content="https://i.imgur.com/a4KQPvv.jpg"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="Devops"><meta property="article:section" content="AWS"><meta property="article:published_time" content="2022-03-08 20:29:47 +0200 +0200"><p align=center style=background-color:#23b0ff>Sign up for my <a href=https://tinyletter.com/mpostument>email
newsletter</a> or use this <a href=/index.xml>RSS feed</a> to get notified of new blog posts.</p><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8633398301520801" crossorigin=anonymous></script></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>mpostument.com</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/categories/>Categories</a></li><li><a href=/tags/>Tags</a></li><li><a href=/projects/>Projects</a></li><hr><li><a href=https://mpostument.com/>English</a></li><li><a href=https://mpostument.com/ua/>Ukraine</a></li></ul></li></ul><ul class="menu menu--desktop menu--language-selector"><li class=menu__trigger>English&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://mpostument.com/>English</a></li><li><a href=https://mpostument.com/ua/>Ukraine</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>Home</a></li><li><a href=/categories/>Categories</a></li><li><a href=/tags/>Tags</a></li><li><a href=/projects/>Projects</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://mpostument.com/2022/03/08/aws-synthetics-with-terraform/>AWS Synthetics With Terraform. Problems?</a></h1><div class=post-meta><time class=post-date>2022-03-08 ::</time>
<span class=post-author>Maksym Postument</span>
<span class=post-reading-time>:: 4 min read (727 words)</span></div><span class=post-tags>#<a href=https://mpostument.com/tags/aws/>AWS</a>&nbsp;
#<a href=https://mpostument.com/tags/devops/>Devops</a>&nbsp;
#<a href=https://mpostument.com/tags/terraform/>Terraform</a>&nbsp;</span>
<img src=https://i.imgur.com/a4KQPvv.jpg class=post-cover alt="AWS Synthetics With Terraform. Problems?" title="Cover Image"><div class=post-content><div><p>Hi there!</p><p>Recently, I used terraform to automate the creation for <code>AWS Synthetics</code>, and I encountered several problems and I want to share how I solved them.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>locals</span> {
</span></span><span style=display:flex><span>  common_tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    cost-center <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;observability&#34;</span>
</span></span><span style=display:flex><span>    label       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;canary&#34;</span>
</span></span><span style=display:flex><span>    environment <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;staging&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;archive_file&#34; &#34;login&#34;</span> {
</span></span><span style=display:flex><span>  type       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;zip&#34;</span>
</span></span><span style=display:flex><span>  source_dir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/functions/login/&#34;</span>
</span></span><span style=display:flex><span>  output_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/functions/login.zip&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_synthetics_canary&#34; &#34;login&#34;</span> {
</span></span><span style=display:flex><span>  name                 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;login_test&#34;</span>
</span></span><span style=display:flex><span>  artifact_s3_location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;s3://my_canary_bucket/&#34;</span>
</span></span><span style=display:flex><span>  execution_role_arn   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;role_arn&#34;</span>
</span></span><span style=display:flex><span>  handler              <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;index.handler&#34;</span>
</span></span><span style=display:flex><span>  zip_file             <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>archive_file</span>.<span style=color:#66d9ef>login</span>.<span style=color:#66d9ef>output_path</span>
</span></span><span style=display:flex><span>  runtime_version      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;syn-nodejs-puppeteer-3.4&#34;</span>
</span></span><span style=display:flex><span>  start_canary         <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>schedule</span> {
</span></span><span style=display:flex><span>    expression <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;rate(5 minutes)&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>run_config</span> {
</span></span><span style=display:flex><span>    timeout_in_seconds <span style=color:#f92672>=</span> <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> <span style=color:#66d9ef>merge</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>common_tags</span>
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The first problem I encountered was that Lambda, which canary automatically creates, has no tags. To tag it, I used <code>null_resource</code>. Lambda ARN can be obtained from terraform using <code>aws_synthetics_canary.login.engine_arn</code>, but the problem is that arn contains a lambda version <code>arn:aws:lambda:us-east-1:123456789:function:my_lambda:15</code>. And to be able to tag the version is not required. To remove the version from the lambda, I added the following to <code>locals</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span>  lambda_regex       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;arn:aws:lambda:[a-z]{2}-[a-z]+-\\d{1}:\\d{12}:function:[a-zA-Z0-9-_]+&#34;</span>
</span></span><span style=display:flex><span>  login_lambda_name  <span style=color:#f92672>=</span> <span style=color:#66d9ef>regex</span>(<span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>lambda_regex</span>, <span style=color:#66d9ef>aws_synthetics_canary</span>.<span style=color:#66d9ef>login</span>.<span style=color:#66d9ef>engine_arn</span>)
</span></span></code></pre></div><p>Now that there is an Arn with <code>null_resource</code> you can patch the lambda. <code>Triggers</code> indicates in which cases to run <code>null_resource</code>. In this case, <code>null_resource</code> will run if the tag in the common_tags folder changes or aws_synthetics_canary id changes (when the canary is converted). And in provisioner <code>"local-exec"</code> I start <code>aws lambda tag-resource</code> in which I transfer lambda ARN and tags. The only thing that <code>aws lambda tag-resource</code> supports tags in format <code>KeyName1=string,KeyName2=string</code> and I have them in map. To convert them to string following need to be added to <code>locals</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span>  tags               <span style=color:#f92672>=</span> trimsuffix(join(&#34; &#34;, formatlist(&#34;%s<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>%</span><span style=color:#66d9ef>s</span>,<span style=color:#e6db74>&#34;, keys(local.common_tags), values(local.common_tags))), &#34;,&#34;</span>)
</span></span></code></pre></div><p>After creating <code>aws_synthetics_canary</code>, a lambda will be tagged.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;null_resource&#34; &#34;tag_login_backend_lambda&#34;</span> {
</span></span><span style=display:flex><span>  triggers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    tags   <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>tags</span>
</span></span><span style=display:flex><span>    canary <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_synthetics_canary</span>.<span style=color:#66d9ef>login</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>provisioner</span> <span style=color:#e6db74>&#34;local-exec&#34;</span> {
</span></span><span style=display:flex><span>    command <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;aws lambda tag-resource --resource ${local.login_lambda_name} --tags &#39;${local.tags}&#39;&#34;</span>
</span></span><span style=display:flex><span>    environment <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      AWS_PROFILE <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>production</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_synthetics_canary</span>.<span style=color:#66d9ef>login</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The next problem is that the <code>aws_synthetics_canary</code> resource does not support environment variables. They also can be added with <code>null_resource</code>. To do this, you need to add environment variables to <code>locals</code>. In my case, it will be a map in which will be only one variable <code>app_url</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span>  canary_variables <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    &#34;app_url&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://mpostument.com&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>Triggers look similar to the previous example, only canary_variables has a type map and needs to be converted to <code>string</code>, because triggers only support type <code>string</code>. <code>aws synthetics update-canary</code>, need to include additional parameters besides environment variables. If they won&rsquo;t be provided, <code>aws cli</code> will set them to default. In my case, I am using values retrieved from terraform resource <code>aws_synthetics_canary.login</code>. And this guarantees that those parameters will be the same for <code>aws_synthetics_canary.login</code> and <code>null_resource</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;null_resource&#34; &#34;add_environment_variables_login_canary&#34;</span> {
</span></span><span style=display:flex><span>  triggers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    canary_variables <span style=color:#f92672>=</span> join(&#34;,&#34;, [for key, value in local.canary_variables : &#34;${key}<span style=color:#f92672>=</span><span style=color:#e6db74>${</span><span style=color:#960050;background-color:#1e0010>value</span><span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>&#34;</span>])
</span></span><span style=display:flex><span>    canary           <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_synthetics_canary</span>.<span style=color:#66d9ef>login</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>provisioner</span> <span style=color:#e6db74>&#34;local-exec&#34;</span> {
</span></span><span style=display:flex><span>    command <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;aws synthetics update-canary --name ${aws_synthetics_canary.login.name} --run-config &#39;${jsonencode({ TimeoutInSeconds : aws_synthetics_canary.create.run_config[0].timeout_in_seconds, MemoryInMB : aws_synthetics_canary.create.run_config[0].memory_in_mb, ActiveTracing : aws_synthetics_canary.create.run_config[0].active_tracing, EnvironmentVariables : var.canary_variables })}&#39;&#34;</span>
</span></span><span style=display:flex><span>    environment <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      AWS_PROFILE <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>aws_profile_name</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_synthetics_canary</span>.<span style=color:#66d9ef>create</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Another problem is that the canary code is not automatically updated, in order for it to be updated the archive name must be different each time. This can be done using the <code>filemd5</code> function. This is what the <code>archive_file</code> will look like with new changes</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>locals</span> {
</span></span><span style=display:flex><span>  login_function_location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/functions/login/nodejs/node_modules/index.js&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;archive_file&#34; &#34;login&#34;</span> {
</span></span><span style=display:flex><span>  type       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;zip&#34;</span>
</span></span><span style=display:flex><span>  source_dir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/functions/login/&#34;</span>
</span></span><span style=display:flex><span>  output_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/functions/login-${filemd5(local.login_function_location)}.zip&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This way the hash of the file will be counted each time and if it has changed the new archive will be created and the canary code will be updated.</p><p>Another problem is that when calling <code>terraform destroy</code> the lambda which is automatically created <code>aws_synthetics_canary</code> is not removed. I haven&rsquo;t solved it yet.</p><p>UPD:
Support for <code>environment_variables</code> has been added in the AWS provider version <a href=https://github.com/hashicorp/terraform-provider-aws/blob/main/CHANGELOG.md#450-march-11-2022>4.5.0</a>. In order to add them, you need to specify a map in run_config with the required environment variables.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>locals</span> {
</span></span><span style=display:flex><span>  canary_variables <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    &#34;app_url&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://mpostument.com&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  login_function_location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/functions/login/nodejs/node_modules/index.js&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;archive_file&#34; &#34;login&#34;</span> {
</span></span><span style=display:flex><span>  type       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;zip&#34;</span>
</span></span><span style=display:flex><span>  source_dir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/functions/login/&#34;</span>
</span></span><span style=display:flex><span>  output_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/functions/login-${filemd5(local.login_function_location)}.zip&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_synthetics_canary&#34; &#34;login&#34;</span> {
</span></span><span style=display:flex><span>  name                 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;login_test&#34;</span>
</span></span><span style=display:flex><span>  artifact_s3_location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;s3://my_canary_bucket/&#34;</span>
</span></span><span style=display:flex><span>  execution_role_arn   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;role_arn&#34;</span>
</span></span><span style=display:flex><span>  handler              <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;index.handler&#34;</span>
</span></span><span style=display:flex><span>  zip_file             <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>archive_file</span>.<span style=color:#66d9ef>login</span>.<span style=color:#66d9ef>output_path</span>
</span></span><span style=display:flex><span>  runtime_version      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;syn-nodejs-puppeteer-3.4&#34;</span>
</span></span><span style=display:flex><span>  start_canary         <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>schedule</span> {
</span></span><span style=display:flex><span>    expression <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;rate(5 minutes)&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>run_config</span> {
</span></span><span style=display:flex><span>    timeout_in_seconds    <span style=color:#f92672>=</span> <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span>    environment_variables <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>canary_variables</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> <span style=color:#66d9ef>merge</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>common_tags</span>
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mpostument.com/2022/03/15/using-mongo-with-go/><span class=button__icon>←</span>
<span class=button__text>Using Mongo With Go</span></a></span>
<span class="button next"><a href=https://mpostument.com/2022/02/20/using-postgres-with-go/><span class=button__text>Using Postgres With Golang</span>
<span class=button__icon>→</span></a></span></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mpostument-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>