<!doctype html><html lang=ua><head><title>Deploy to ec2 with codedship :: mpostument.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Привіт!
Сьогодні я хочу показати як можна задеплоїти код на AWS EC2 за допомогою CodeShip Basic. Для цього я використаю інтеграцію Codeship з AWS CodeDeploy.
CodeShip Configuration Спочатку потрібо добавити репозиторій в CodeShip і перейти в вкладу Deploy. І добавити branch з якої відбувається деплой на ec2. В моєму випадку branch master вже є добавлена. Після того як branch добавлено потрібно проскролити в низ до секції Deployment. І вибрати CodeDeploy Одразу зявиться наступна форма Тут потрібно ввести Access and Secret Keys користувача який буде здійснювати деплой."><meta name=keywords content="Codeship,CI/CD,Devops,AWS"><meta name=robots content="noodp"><link rel=canonical href=/ua/2020/09/16/deploy-to-ec2-with-codeship/><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-176839804-1','auto');ga('send','pageview');}</script><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/blue.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/blue.png><meta name=twitter:card content="summary"><meta name=twitter:site content="mpostument.com"><meta name=twitter:creator content="Maks_Postument"><meta property="og:locale" content="ua"><meta property="og:type" content="article"><meta property="og:title" content="Deploy to ec2 with codedship"><meta property="og:description" content="Привіт!
Сьогодні я хочу показати як можна задеплоїти код на AWS EC2 за допомогою CodeShip Basic. Для цього я використаю інтеграцію Codeship з AWS CodeDeploy.
CodeShip Configuration Спочатку потрібо добавити репозиторій в CodeShip і перейти в вкладу Deploy. І добавити branch з якої відбувається деплой на ec2. В моєму випадку branch master вже є добавлена. Після того як branch добавлено потрібно проскролити в низ до секції Deployment. І вибрати CodeDeploy Одразу зявиться наступна форма Тут потрібно ввести Access and Secret Keys користувача який буде здійснювати деплой."><meta property="og:url" content="/ua/2020/09/16/deploy-to-ec2-with-codeship/"><meta property="og:site_name" content="mpostument.com"><meta property="og:image" content="https://i.imgur.com/lSqRdnq.jpg?1"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="Devops"><meta property="article:published_time" content="2020-09-16 20:24:40 +0300 +0300"></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/ua><div class=logo>mpostument.com</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/ua>Home</a></li><li><a href=/ua/tags/>Tags</a></li><div class=spacer></div><ul class=language-selector><ul class=language-selector-current><li>Ukraine ▾</li></ul><ul class="language-selector__more hidden"><li><a href=/>English</a></li><li><a href=/ua/>Ukraine</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/ua>Home</a></li><li><a href=/ua/tags/>Tags</a></li><hr><li><a href=/>English</a></li><li><a href=/ua/>Ukraine</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/ua/2020/09/16/deploy-to-ec2-with-codeship/>Deploy to ec2 with codedship</a></h1><div class=post-meta><span class=post-date>2020-09-16</span>
<span class=post-author>:: Maksym Postument</span></div><span class=post-tags>#<a href=/ua/tags/codeship/>Codeship</a>&nbsp;
#<a href=/ua/tags/aws/>AWS</a>&nbsp;
#<a href=/ua/tags/devops/>Devops</a>&nbsp;</span>
<img src=https://i.imgur.com/lSqRdnq.jpg?1 class=post-cover alt="Deploy to ec2 with codedship"><div class=post-content><div><p>Привіт!</p><p>Сьогодні я хочу показати як можна задеплоїти код на AWS EC2 за допомогою CodeShip Basic.
Для цього я використаю інтеграцію Codeship з AWS CodeDeploy.</p><h2 id=codeship-configuration>CodeShip Configuration<a href=#codeship-configuration class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Спочатку потрібо добавити репозиторій в CodeShip і перейти в вкладу Deploy.
<img src=https://i.imgur.com/Zz2v8aZ.png alt=Coeship1></p><p>І добавити branch з якої відбувається деплой на ec2. В моєму випадку branch master вже є добавлена.
Після того як branch добавлено потрібно проскролити в низ до секції Deployment. І вибрати CodeDeploy
<img src=https://i.imgur.com/KVCmUDn.png alt=Codeship2></p><p>Одразу зявиться наступна форма
<img src=https://i.imgur.com/rfdRxKl.png alt=CodeshipForm3>
Тут потрібно ввести Access and Secret Keys користувача який буде здійснювати деплой. Користувач має мати доступ до s3 та CodeDeploy.
В регіон вказати ваш AWS Region де знаходится аплікація. Для мене це us-east-1.<br><code>Application</code>, <code>GroupName</code> потрібно буде створити в AWS. Значення варто вибирати таке щоб було зрозуміло яка аплікаця деплоїться. <code>S3 Bucket</code> може бути як загальний бакет куди будуть здійснювати усі деплойменти черех codeship або обрати індивідуальне ім&rsquo;я для однієї аплікації. В моєму випадку це CodeShipEc2Deployment.<br>І останє це <code>Config Name</code> потрібно вказати назву конфігурації в CodeDeploy. Я візьму стандартну <code>CodeDeployDefault.AllAtOnce</code>. Це означає що деплой буде відбуватись одразу на всі ec2 інстанси</p><p>Тепер з CodeShip закінчено і можна приступати до налаштування AWS.</p><h2 id=codedeploy-configuration>CodeDeploy Configuration<a href=#codedeploy-configuration class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Відкрите CodeDeploy сервіс в AWS.<br><img src=https://i.imgur.com/cTv6l3Y.png alt=CodeDeploy>
В секції Deployment знайдіть Applications<br><img src=https://i.imgur.com/BAZ6E6d.png alt=Applications><br>Натисніть Create Application. Введіть назву таку ж як і в Codeship в секції <code>Application</code>. Як Compute Platform оберіть EC2
<img src=https://i.imgur.com/zAXUxuF.png alt=CreateApplication>
Відкрийте тільки що створену <code>Application</code> і в <code>Deployment Groups</code> оберіть <code>Create Deployment Group</code><br><img src=https://i.imgur.com/5wfA0VU.png alt=DeploymentGroup>
В <code>Deployment group name</code> потрібно вкзати таку ж назву яка була вказана в CodeShip.
В <code>ServiceRole</code> потрібно обрати роль яка дозволить здійснювати деплой на ec2. Хороший приклад ролі можна знайти <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/getting-started-create-service-role.html>тут</a>.</p><p>В <code>Environment configuration</code> оберіть ec2. Далі потрібно вказати який tag використовуватись для фільтра ec2. Наприклад це може буде Key=Name, Value=ProductionApplication. Тут можна використовувати будь які теги які є на вашому ec2 на який має здійснювати деплоймент.<br><img src=https://i.imgur.com/ffGKRQV.png alt=Ec2Filter></p><h2 id=ec2-configuration>Ec2 Configuration<a href=#ec2-configuration class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Для ec2 буде потрібна ще одна роль. Які доступи вона має мати можна знайти <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/instances-ec2-configure.html#instances-ec2-configure-2-verify-instance-profile-permissions>тут</a></p><p>Після того як роль створена її потрібно заасайнити на ec2 інстанс. Для цього оберіть потрібний ec2. Натисніть правою кнопкою миші і виберіть Attach Role
<img src=https://i.imgur.com/uaIUcyg.png alt=AttachRole>
В спику знайдіть вище створену роль.<br>Тепер на ec2 інстанс потрібно поставити CodeDeploy Agent. Для цього підключіться до сервера по ssh
<code>ssh -i private_key ec2-user@IP</code>. Далі буде приклад для AmazonLinux. Якщо в вас інша OS команди можна знайти <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/codedeploy-agent-operations-install-cli.html>тут</a>.</p><ul><li>Скачати інсталяцію <code>wget https://aws-codedeploy-us-east-1.s3.us-east-1.amazonaws.com/latest/install</code></li><li>Надати пермішини <code>sudo chmod +x install</code></li><li>Встановити <code>sudo ./install auto</code></li></ul><p>Перевірити чи агент запущено можна командою <code>sudo service codedeploy-agent status</code>. Результат має бути орієнтовно такий <code>The AWS CodeDeploy agent is running as PID 32466</code>.<br>Також потрібно створити папку в які буде знаходитись аплікація <code>mkdir /opt/application</code> і дати пермішин для користувача. Я викоистовую ec2-user <code>chown ec2-user:ec2-user /opt/application</code></p><h2 id=deployment-script>Deployment Script<a href=#deployment-script class=hanchor arialabel=Anchor>&#8983;</a></h2><p>В корені репозиторія потрібно створити файл який має називатись <code>appspec.yml</code>. Тут можна знайти всі опції які підтримує цей файл - <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file.html>AWS</a>.</p><p>Ось приклад мого файла:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>version</span>: <span style=color:#ae81ff>0.0</span>
<span style=color:#f92672>os</span>: <span style=color:#ae81ff>linux</span>
<span style=color:#f92672>files</span>:
  - <span style=color:#f92672>source</span>: <span style=color:#ae81ff>/</span>
    <span style=color:#f92672>destination</span>: <span style=color:#ae81ff>/opt/application</span>
<span style=color:#f92672>permissions</span>:
  - <span style=color:#f92672>object</span>: <span style=color:#ae81ff>/opt/application</span>
    <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>ec2-user</span>
    <span style=color:#f92672>group</span>: <span style=color:#ae81ff>ec2-user</span>
<span style=color:#f92672>hooks</span>:
   <span style=color:#f92672>AfterInstall</span>:
   - <span style=color:#f92672>location</span>: <span style=color:#ae81ff>ops/deploybuild.sh</span>
     <span style=color:#f92672>runas</span>: <span style=color:#ae81ff>ec2-user</span>
</code></pre></div><p><code>version</code> має стандартне значення і міняти його не потрібно. 0.0 Єдине значення як підтримується
<code>os</code> може бути двох значення windows або linux, оскільки в мене OS на EC2 AmazonLinux я обираю linux
<code>files</code> вказує які файли потрібно копіювати на сервер під час деплойменту. <code>source: /</code> означає копіювати всі файли. <code>destination</code> куди копіювати.<br>В <code>permissions</code> зазначено які пермішини мають мати щойно скопійовані файли.<br>В <code>hooks</code> секції відбувається конфігурація аплікації. Я використовую <code>AfterInstall</code> hook. Це означає що скрипт буде запущено після <code>Install</code> кроку. Під час <code>Install</code> кроку файли копіюються на сервер. В <code>location</code> вказано який скрипт запускати та від його корисувача. <code>runas</code> означає що скрипт буде викликатись від імені користувача. По дефолту code-deploy agent запускається від рута і runas на цьому етапі переключить на ec2-user. Також можна поміняти щоб code-deploy agent запускався одарзу від ec2-user.</p><p>Далі нам потрібен деплой скрипт. В репозиторії я створив папку ops оскільки шлях до мого скрипта <code>- location: ops/deploybuild.sh</code>. І в цій папку створив скрипт <code>deploybuild.sh</code>.
В мене node.js аплікації для якою потрібно зробити yarn install та npm start. Я це добавлю в скрипт</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/usr/bin/env bash
</span><span style=color:#75715e></span>cd /opt/application
yarn --ignore-engines
cd examples/demo-app/
<span style=color:#f92672>(</span>npm run start-prod<span style=color:#f92672>)</span>&amp;
</code></pre></div><p>Це базовий скрипт як можна запустити node аплікацію. Для продакшина варто використовувати pm2 для старту js аплікацій.
Тепер залишилось зробити коміт в master branch і codedeploy запуститься автоматично</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/ua/2020/09/30/nightfall-dlp-configuration/><span class=button__icon>←</span>
<span class=button__text>Nightfall Dlp Configuration</span></a></span>
<span class="button next"><a href=/ua/2020/09/01/get-lambdas-in-vpc-with-go/><span class=button__text>Get Lambdas in Vpc With Go</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2020 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script><script src=/assets/languageSelector.js></script></div></body></html>