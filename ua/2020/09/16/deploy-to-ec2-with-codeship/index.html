<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Deploy to ec2 with codedship &#183; Maksym Postument</title><meta name=description content="Привіт!
Сьогодні я хочу показати як можна задеплоїти код на AWS EC2 за допомогою CodeShip Basic. Для цього я використаю інтеграцію Codeship з AWS CodeDeploy.
CodeShip Configuration Спочатку потрібо добавити репозиторій в CodeShip і перейти в вкладу Deploy. І добавити branch з якої відбувається деплой на ec2. В моєму випадку branch master вже є добавлена. Після того як branch добавлено потрібно проскролити в низ до секції Deployment. І вибрати CodeDeploy Одразу зявиться наступна форма Тут потрібно ввести Access and Secret Keys користувача який буде здійснювати деплой."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.74.3"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Deploy to ec2 with codedship"><meta property="og:description" content="Привіт!
Сьогодні я хочу показати як можна задеплоїти код на AWS EC2 за допомогою CodeShip Basic. Для цього я використаю інтеграцію Codeship з AWS CodeDeploy.
CodeShip Configuration Спочатку потрібо добавити репозиторій в CodeShip і перейти в вкладу Deploy. І добавити branch з якої відбувається деплой на ec2. В моєму випадку branch master вже є добавлена. Після того як branch добавлено потрібно проскролити в низ до секції Deployment. І вибрати CodeDeploy Одразу зявиться наступна форма Тут потрібно ввести Access and Secret Keys користувача який буде здійснювати деплой."><meta property="og:type" content="article"><meta property="og:url" content="/ua/2020/09/16/deploy-to-ec2-with-codeship/"><link rel=stylesheet href=/dist/site.css><link rel=stylesheet href=/dist/syntax.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous></head><body><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-176839804-1','auto');ga('send','pageview');}</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=mpostument.com href=/>mpostument.com</a></h1><a class=button-square href=/index.xml><i class="fa fa-rss"></i></a><a class="button-square button-social hint--top" data-hint=Twitter title=Twitter href=https://twitter.com/Maks_Postument rel=me><i class="fa fa-twitter"></i></a><a class="button-square button-social hint--top" data-hint=Github title=Github href=https://github.com/mpostument rel=me><i class="fa fa-github-alt"></i></a><a class="button-square button-social hint--top" data-hint=Email title=Email href=mailto:777rip777@gmail.com><i class="fa fa-envelope"></i></a></div><ul class=site-nav><li class=site-nav-item><a title=About href=/about/>About</a></li><li class=site-nav-item><a title=Home href=/>Home</a></li><li class=site-nav-item><a title=Projects href=/projects/>Projects</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Deploy to ec2 with codedship</h1><p class=post-date><span>Published <time datetime=2020-09-16 itemprop=datePublished>Wed, Sep 16, 2020</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=https://github.com/mpostument itemprop=url rel=author>Maksym Postument</a></span></span></p><p class="post-reading post-line"><span>4 min</span></p><nav class=LangNav>Language:
<a href=/2020/09/16/deploy-to-ec2-with-codeship/>English</a></nav></header><div class="post-content clearfix" itemprop=articleBody><img class=post-featured-image src=https://i.imgur.com/lSqRdnq.jpg?1><p>Привіт!</p><p>Сьогодні я хочу показати як можна задеплоїти код на AWS EC2 за допомогою CodeShip Basic.
Для цього я використаю інтеграцію Codeship з AWS CodeDeploy.</p><h2 id=codeship-configuration>CodeShip Configuration</h2><p>Спочатку потрібо добавити репозиторій в CodeShip і перейти в вкладу Deploy.
<img src=https://i.imgur.com/Zz2v8aZ.png alt=Coeship1></p><p>І добавити branch з якої відбувається деплой на ec2. В моєму випадку branch master вже є добавлена.
Після того як branch добавлено потрібно проскролити в низ до секції Deployment. І вибрати CodeDeploy
<img src=https://i.imgur.com/KVCmUDn.png alt=Codeship2></p><p>Одразу зявиться наступна форма
<img src=https://i.imgur.com/rfdRxKl.png alt=CodeshipForm3>
Тут потрібно ввести Access and Secret Keys користувача який буде здійснювати деплой. Користувач має мати доступ до s3 та CodeDeploy.
В регіон вказати ваш AWS Region де знаходится аплікація. Для мене це us-east-1.<br><code>Application</code>, <code>GroupName</code> потрібно буде створити в AWS. Значення варто вибирати таке щоб було зрозуміло яка аплікаця деплоїться. <code>S3 Bucket</code> може бути як загальний бакет куди будуть здійснювати усі деплойменти черех codeship або обрати індивідуальне ім&rsquo;я для однієї аплікації. В моєму випадку це CodeShipEc2Deployment.<br>І останє це <code>Config Name</code> потрібно вказати назву конфігурації в CodeDeploy. Я візьму стандартну <code>CodeDeployDefault.AllAtOnce</code>. Це означає що деплой буде відбуватись одразу на всі ec2 інстанси</p><p>Тепер з CodeShip закінчено і можна приступати до налаштування AWS.</p><h2 id=codedeploy-configuration>CodeDeploy Configuration</h2><p>Відкрите CodeDeploy сервіс в AWS.<br><img src=https://i.imgur.com/cTv6l3Y.png alt=CodeDeploy>
В секції Deployment знайдіть Applications<br><img src=https://i.imgur.com/BAZ6E6d.png alt=Applications><br>Натисніть Create Application. Введіть назву таку ж як і в Codeship в секції <code>Application</code>. Як Compute Platform оберіть EC2
<img src=https://i.imgur.com/zAXUxuF.png alt=CreateApplication>
Відкрийте тільки що створену <code>Application</code> і в <code>Deployment Groups</code> оберіть <code>Create Deployment Group</code><br><img src=https://i.imgur.com/5wfA0VU.png alt=DeploymentGroup>
В <code>Deployment group name</code> потрібно вкзати таку ж назву яка була вказана в CodeShip.
В <code>ServiceRole</code> потрібно обрати роль яка дозволить здійснювати деплой на ec2. Хороший приклад ролі можна знайти <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/getting-started-create-service-role.html>тут</a>.</p><p>В <code>Environment configuration</code> оберіть ec2. Далі потрібно вказати який tag використовуватись для фільтра ec2. Наприклад це може буде Key=Name, Value=ProductionApplication. Тут можна використовувати будь які теги які є на вашому ec2 на який має здійснювати деплоймент.<br><img src=https://i.imgur.com/ffGKRQV.png alt=Ec2Filter></p><h2 id=ec2-configuration>Ec2 Configuration</h2><p>Для ec2 буде потрібна ще одна роль. Які доступи вона має мати можна знайти <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/instances-ec2-configure.html#instances-ec2-configure-2-verify-instance-profile-permissions>тут</a></p><p>Після того як роль створена її потрібно заасайнити на ec2 інстанс. Для цього оберіть потрібний ec2. Натисніть правою кнопкою миші і виберіть Attach Role
<img src=https://i.imgur.com/uaIUcyg.png alt=AttachRole>
В спику знайдіть вище створену роль.<br>Тепер на ec2 інстанс потрібно поставити CodeDeploy Agent. Для цього підключіться до сервера по ssh
<code>ssh -i private_key ec2-user@IP</code>. Далі буде приклад для AmazonLinux. Якщо в вас інша OS команди можна знайти <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/codedeploy-agent-operations-install-cli.html>тут</a>.</p><ul><li>Скачати інсталяцію <code>wget https://aws-codedeploy-us-east-1.s3.us-east-1.amazonaws.com/latest/install</code></li><li>Надати пермішини <code>sudo chmod +x install</code></li><li>Встановити <code>sudo ./install auto</code></li></ul><p>Перевірити чи агент запущено можна командою <code>sudo service codedeploy-agent status</code>. Результат має бути орієнтовно такий <code>The AWS CodeDeploy agent is running as PID 32466</code>.<br>Також потрібно створити папку в які буде знаходитись аплікація <code>mkdir /opt/application</code> і дати пермішин для користувача. Я викоистовую ec2-user <code>chown ec2-user:ec2-user /opt/application</code></p><h2 id=deployment-script>Deployment Script</h2><p>В корені репозиторія потрібно створити файл який має називатись <code>appspec.yml</code>. Тут можна знайти всі опції які підтримує цей файл - <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file.html>AWS</a>.</p><p>Ось приклад мого файла:</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=m>0.0</span><span class=w>
</span><span class=w></span><span class=k>os</span><span class=p>:</span><span class=w> </span>linux<span class=w>
</span><span class=w></span><span class=k>files</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>source</span><span class=p>:</span><span class=w> </span>/<span class=w>
</span><span class=w>    </span><span class=k>destination</span><span class=p>:</span><span class=w> </span>/opt/application<span class=w>
</span><span class=w></span><span class=k>permissions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>object</span><span class=p>:</span><span class=w> </span>/opt/application<span class=w>
</span><span class=w>    </span><span class=k>owner</span><span class=p>:</span><span class=w> </span>ec2-user<span class=w>
</span><span class=w>    </span><span class=k>group</span><span class=p>:</span><span class=w> </span>ec2-user<span class=w>
</span><span class=w></span><span class=k>hooks</span><span class=p>:</span><span class=w>
</span><span class=w>   </span><span class=k>AfterInstall</span><span class=p>:</span><span class=w>
</span><span class=w>   </span>- <span class=k>location</span><span class=p>:</span><span class=w> </span>ops/deploybuild.sh<span class=w>
</span><span class=w>     </span><span class=k>runas</span><span class=p>:</span><span class=w> </span>ec2-user<span class=w>
</span></code></pre></div><p><code>version</code> має стандартне значення і міняти його не потрібно. 0.0 Єдине значення як підтримується
<code>os</code> може бути двох значення windows або linux, оскільки в мене OS на EC2 AmazonLinux я обираю linux
<code>files</code> вказує які файли потрібно копіювати на сервер під час деплойменту. <code>source: /</code> означає копіювати всі файли. <code>destination</code> куди копіювати.<br>В <code>permissions</code> зазначено які пермішини мають мати щойно скопійовані файли.<br>В <code>hooks</code> секції відбувається конфігурація аплікації. Я використовую <code>AfterInstall</code> hook. Це означає що скрипт буде запущено після <code>Install</code> кроку. Під час <code>Install</code> кроку файли копіюються на сервер. В <code>location</code> вказано який скрипт запускати та від його корисувача. <code>runas</code> означає що скрипт буде викликатись від імені користувача. По дефолту code-deploy agent запускається від рута і runas на цьому етапі переключить на ec2-user. Також можна поміняти щоб code-deploy agent запускався одарзу від ec2-user.</p><p>Далі нам потрібен деплой скрипт. В репозиторії я створив папку ops оскільки шлях до мого скрипта <code>- location: ops/deploybuild.sh</code>. І в цій папку створив скрипт <code>deploybuild.sh</code>.
В мене node.js аплікації для якою потрібно зробити yarn install та npm start. Я це добавлю в скрипт</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/usr/bin/env bash
</span><span class=cp></span><span class=nb>cd</span> /opt/application
yarn --ignore-engines
<span class=nb>cd</span> examples/demo-app/
<span class=o>(</span>npm run start-prod<span class=o>)</span><span class=p>&amp;</span>
</code></pre></div><p>Це базовий скрипт як можна запустити node аплікацію. Для продакшина варто використовувати pm2 для старту js аплікацій.
Тепер залишилось зробити коміт в master branch і codedeploy запуститься автоматично</p></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=/ua/tags/codeship/>Codeship</a>,
<a href=/ua/tags/aws/>AWS</a>,
<a href=/ua/tags/devops/>Devops</a></p><div class=share><a class=icon-twitter href="https://twitter.com/share?text=Deploy%20to%20ec2%20with%20codedship&url=%2fua%2f2020%2f09%2f16%2fdeploy-to-ec2-with-codeship%2f" onclick="window.open(this.href,'twitter-share','width=550,height=235');return false;"><i class="fa fa-twitter"></i><span class=hidden>Twitter</span></a>
<a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=%2fua%2f2020%2f09%2f16%2fdeploy-to-ec2-with-codeship%2f" onclick="window.open(this.href,'facebook-share','width=580,height=296');return false;"><i class="fa fa-facebook"></i><span class=hidden>Facebook</span></a>
<a class=icon-google-plus href="https://plus.google.com/share?url=%2fua%2f2020%2f09%2f16%2fdeploy-to-ec2-with-codeship%2f" onclick="window.open(this.href,'google-plus-share','width=490,height=530');return false;"><i class="fa fa-google-plus"></i><span class=hidden>Google+</span></a></div></footer></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=mpostument.com href=/>mpostument.com</a></h1><a class="button-square button-jump-top js-jump-top" href=#><i class="fa fa-angle-up"></i></a></div><p class=footer-copyright><span>&copy; 2020 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/roryg/ghostwriter>Ghostwriter theme</a> By <a href=http://jollygoodthemes.com>JollyGoodThemes</a></span>
<span>/ <a href=https://github.com/jbub/ghostwriter>Ported</a> to Hugo By <a href=https://github.com/jbub>jbub</a></span></p></div></footer><script src=/js/jquery-1.11.3.min.js></script><script src=/js/jquery.fitvids.js></script><script src=/js/scripts.js></script></body></html>