<!doctype html><html lang=ua><head><title>Ansible Playbook :: Maksym Postument</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Third article in series about ansible. In this article, I will show how to use playbook to create reusable code"><meta name=keywords content="VSCode,Devops,Ansible,pyenv,RedHat,Beginner,virtualenv,boto3"><meta name=robots content="noodp"><link rel=canonical href=https://mpostument.com/ua/2022/10/04/ansible-playbook/><script async src="https://www.googletagmanager.com/gtag/js?id=G-SBRJXS94DC"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SBRJXS94DC",{anonymize_ip:!1})}</script><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=https://mpostument.com/img/theme-colors/blue.png><link rel=apple-touch-icon href=https://mpostument.com/img/theme-colors/blue.png><meta name=twitter:card content="summary"><meta name=twitter:site content="mpostument.com"><meta name=twitter:creator content="Maks_Postument"><meta property="og:locale" content="ua"><meta property="og:type" content="article"><meta property="og:title" content="Ansible Playbook"><meta property="og:description" content="Third article in series about ansible. In this article, I will show how to use playbook to create reusable code"><meta property="og:url" content="https://mpostument.com/ua/2022/10/04/ansible-playbook/"><meta property="og:site_name" content="Maksym Postument"><meta property="og:image" content="https://mpostument.com/ansible/ansible-playbook.jpg"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="Devops"><meta property="article:section" content="Ansible"><meta property="article:section" content="Beginner"><meta property="article:published_time" content="2022-10-04 22:51:59 +0300 +0300"><p align=center style=background-color:#23b0ff>Sign up for my <a href=https://tinyletter.com/mpostument>email
newsletter</a> or use this <a href=/index.xml>RSS feed</a> to get notified of new blog posts.</p><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8633398301520801" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/algoliasearch@4.14.2/dist/algoliasearch-lite.umd.js></script>
<script src=https://cdn.jsdelivr.net/npm/@algolia/autocomplete-js></script>
<script src=https://cdn.jsdelivr.net/npm/@algolia/autocomplete-preset-algolia></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@algolia/autocomplete-theme-classic><div id=autocomplete></div><script>var searchClient=algoliasearch("8HJOK7X4MI","a882cdf8954678175d442905d08d8926");const{autocomplete}=window["@algolia/autocomplete-js"],{getAlgoliaResults}=window["@algolia/autocomplete-preset-algolia"];autocomplete({container:"#autocomplete",placeholder:"Search",getSources({query:e}){return[{sourceId:"title",getItems(){return getAlgoliaResults({searchClient,queries:[{indexName:"mpostument",query:e,params:{hitsPerPage:5,attributesToSnippet:["title:15","description:35"],snippetEllipsisText:"…"}}]})},templates:{item({item:e,components:t,html:n}){return n`<div class="aa-ItemWrapper">
                            <div class="aa-ItemContent">
                              <div class="aa-ItemContentBody">
                                <div class="aa-ItemContentTitle">
                                  ${t.Highlight({hit:e,attribute:"title"})}
                                </div>
                                <div class="aa-ItemContentDescription">
                                  ${t.Snippet({hit:e,attribute:"description"})}
                                </div>
                              </div>
                            </div>
                          </div>`}},getItemUrl({item:e}){return e.href},onSelect({item:e}){window.location.href=e.href}}]}})</script></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/ua><div class=logo>mpostument.com</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/ua>Home</a></li><li><a href=/ua/categories/>Categories</a></li><li><a href=/ua/tags/>Tags</a></li><hr><li><a href=https://mpostument.com/>English</a></li><li><a href=https://mpostument.com/ua/>Ukraine</a></li></ul></li></ul><ul class="menu menu--desktop menu--language-selector"><li class=menu__trigger>Ukraine&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://mpostument.com/>English</a></li><li><a href=https://mpostument.com/ua/>Ukraine</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/ua>Home</a></li><li><a href=/ua/categories/>Categories</a></li><li><a href=/ua/tags/>Tags</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://mpostument.com/ua/2022/10/04/ansible-playbook/>Ansible Playbook</a></h1><div class=post-meta><time class=post-date>2022-10-04 ::</time>
<span class=post-author>Maksym Postument</span>
<span class=post-reading-time>:: 12 min read (2353 words)</span></div><span class=post-tags>#<a href=https://mpostument.com/ua/tags/vscode/>VSCode</a>&nbsp;
#<a href=https://mpostument.com/ua/tags/devops/>Devops</a>&nbsp;
#<a href=https://mpostument.com/ua/tags/ansible/>Ansible</a>&nbsp;
#<a href=https://mpostument.com/ua/tags/pyenv/>pyenv</a>&nbsp;
#<a href=https://mpostument.com/ua/tags/redhat/>RedHat</a>&nbsp;
#<a href=https://mpostument.com/ua/tags/beginner/>Beginner</a>&nbsp;</span>
<img src=https://mpostument.com/ansible/ansible-playbook.jpg class=post-cover alt="Ansible Playbook" title="Cover Image"><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#playbook>Playbook</a></li><li><a href=#ansible-host-variables>Ansible host variables</a></li><li><a href=#debug>Debug</a></li><li><a href=#register-and-set-facts>Register and Set Facts</a></li><li><a href=#condition>Condition</a></li><li><a href=#block>Block</a></li><li><a href=#loop>Loop</a><ul><li><a href=#simple-list>Simple list</a></li><li><a href=#list-of-hashes>List of hashes</a></li><li><a href=#register-var-in-loop>Register var in loop</a></li></ul></li><li><a href=#delegate-to>Delegate To</a></li><li><a href=#failed-when>Failed when</a></li><li><a href=#ignore-errors>Ignore Errors</a></li><li><a href=#video>Video</a></li></ul></nav></div><div class=post-content><div><p><a href=https://mpostument.com/ua/2022/09/19/manage-ansible-versions-with-pyenv/ title="Частина 1 - Manage Ansible Versions With pyenv">Частина 1 - Manage Ansible Versions With pyenv</a><br><a href=https://mpostument.com/ua/2022/09/27/ansible-inventory/ title="Частина 2 - Ansible Inventory">Частина 2 - Ansible Inventory</a></p><p>Привіт!</p><p>Сьогодні покажу що таке ansible-playbook і як їх створювати.</p><h2 id=playbook>Playbook<a href=#playbook class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Ansible Playbooks це повторювана, багаторазова, систему керування конфігурацією та систему розгортання, яка добре підходить для розгортання складних програм. Якщо потрібно виконати завдання за допомогою Ansible більше одного разу, це можна зробити за допомогою playbook.</p><p>Створимо найпростіший playbook. В playbook потрібно вказати його назву, групу серверів на якій він буде виконуватись та самі завдання.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Update web servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>webapp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure apache is at the latest version</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ansible.builtin.yum</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>state</span>: <span style=color:#ae81ff>latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>become</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>В цьому прикладі playbook виконується на групі серверів <code>webservers</code>. На усіх серверах з цієї групи встановлюється остання версія пакета <code>httpd</code> за допомогою <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/yum_module.html>yum</a> модуля. Перед тим як виконати завдання ansible перевіряє чи пакет не ї встановлений, якщо ж він встановлений то нічого не відбудеться.</p><p>Playbook запускається за допомогою команди <code>ansible-playbook</code>. Збережемо наш playbook під назвою <code>main.yml</code> і запустимо</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Ensure apache is at the latest version<span style=color:#f92672>]</span> **********************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>  
</span></span></code></pre></div><h2 id=ansible-host-variables>Ansible host variables<a href=#ansible-host-variables class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Перед тим як playbook почне виконуватись ansible виконує збір інформації про сервер. Цю опцію можна відключити вказавши <code>gather_facts: false</code> в playbook. Ansible збирає багато інформації про операційну систему, мережеві параметри та багато іншого, в такому вигляді</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ansible_all_ipv4_addresses&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;REDACTED IP ADDRESS&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ansible_all_ipv6_addresses&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;REDACTED IPV6 ADDRESS&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ansible_apparmor&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;disabled&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ansible_architecture&#34;</span>: <span style=color:#e6db74>&#34;x86_64&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ansible_bios_date&#34;</span>: <span style=color:#e6db74>&#34;10/02/2022&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ansible_bios_version&#34;</span>: <span style=color:#e6db74>&#34;4.1.5&#34;</span>,
</span></span></code></pre></div><p>Щоб подивитись усю цю інформацію можна викликати adhoc команду, і всі параметри буде надруковано.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible -i inventory all -m ansible.builtin.setup
</span></span></code></pre></div><h2 id=debug>Debug<a href=#debug class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Часом потрібно продебажити виконання playbook або подивитись значення якихось параметрів, все це можна здійснити за допомогою модуля <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/debug_module.html>debug</a> модуля.</p><p>Наприклад мені потрібно побачити значення параметра <code>ansible_bios_version</code> який отримується за допомогою gather_facts в процесі запуску playbook. Це можна зробити так:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Print bios version</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#ae81ff>Bios version is {{ ansible_bios_version }}</span>
</span></span></code></pre></div><p>Запустивши ansible отримаю результат</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml                              ✘ INT  ansible-210 3.9.13 17:29:55
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Print bios version<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Bios version is 4.11.amazon&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=register-and-set-facts>Register and Set Facts<a href=#register-and-set-facts class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Також в ansible можна створювати параметри на основі результату виконання завдання. Наприклад я хочу отримати скільки часу працює система. Це можна здійснити за допомогою виклику linux команди <code>uptime</code>. Але якщо я це зроблю ось так:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Get uptime information</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.shell</span>: <span style=color:#ae81ff>/usr/bin/uptime</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Get uptime information<span style=color:#f92672>]</span> **************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> 
</span></span></code></pre></div><p>В результаті я нічого не отримаю. Щоб отримати відповідь від команди <code>uptime</code> мені треба зберегти результат в параметр. Це робиться за допомогою <code>register: VAR_NAME</code> і тоді значення цього параметра можа вивести в термінал.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Get uptime information</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.shell</span>: <span style=color:#ae81ff>/usr/bin/uptime</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>sys_uptime</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Print system uptime</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;{{ sys_uptime }}&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Get uptime information<span style=color:#f92672>]</span> **************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Print system uptime<span style=color:#f92672>]</span> *****************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;changed&#34;</span>: true,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/uptime&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.005060&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-10-07 14:31:50.846284&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;failed&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;rc&#34;</span>: 0,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-10-07 14:31:50.841224&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34; 14:31:50 up 15 min,  1 user,  load average: 0,01, 0,05, 0,02&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34; 14:31:50 up 15 min,  1 user,  load average: 0,01, 0,05, 0,02&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Якщо ж під час виконання просто потрібно створити параметр це можна здійснити за допомогою модуля <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/set_fact_module.html>set_fact</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Setting host facts using complex arguments</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.set_fact</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>important_var</span>: <span style=color:#ae81ff>important_value</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Print important value</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;{{ important_var }}&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Setting host facts using complex arguments<span style=color:#f92672>]</span> ******************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Print important value<span style=color:#f92672>]</span> ***************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;important_value&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> 
</span></span></code></pre></div><h2 id=condition>Condition<a href=#condition class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Добре коли playbook універсальний і може працювати на різних операційних системах. Але що якщо в нас є специфічні завдання які мають виконатись в Ubuntu але не в RedHat. Це можна здійснити за допомогою умов. Спробуємо створити універсальний playbook який буде встановлювати apache http не залежно від версії ОС. Для Red Hat нам потрібно використати модуль <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/yum_module.html>yum</a> а для Ubuntu <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html>apt</a>. Використаємо умову <a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html#id2>when</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install apache on Redhat</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.yum</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>ansible_facts[&#39;os_family&#39;] == &#34;RedHat&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install apache on Debian</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.apt</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>apache2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>ansible_facts[&#39;os_family&#39;] == &#34;Debian&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Install apache on Redhat<span style=color:#f92672>]</span> ************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Install apache on Debian<span style=color:#f92672>]</span> ************************************************************************************************
</span></span><span style=display:flex><span>skipping: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> 
</span></span></code></pre></div><p>Таким чином завдання виконується тільки в тому випадку якщо умова повертає <code>True</code>, в інших випадках ні.</p><h2 id=block>Block<a href=#block class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Block використовується для того щоб логічно об&rsquo;єднати завдання в ansible. Наприклад можна організувати всі завдання для Ubuntu і на рівні блоку завдати умову. Наприклад</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Debian block</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>block</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install apache on Ubuntu</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.apt</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>apache2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Start service apache2, if not started</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>apache2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>started</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>ansible_facts[&#39;os_family&#39;] == &#34;Debian&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Install apache on Ubuntu<span style=color:#f92672>]</span> ************************************************************************************************
</span></span><span style=display:flex><span>skipping: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Start service apache2, <span style=color:#66d9ef>if</span> not started<span style=color:#f92672>]</span> ***********************************************************************************
</span></span><span style=display:flex><span>skipping: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Також можна хендлити помилки за допомогою. За допомогою rescue i always. Блок rescue виконується тільки у випадку якщо стається помилка в основному блоці. Always запускається завжди, не зважаючи на те що відбулось в попередньому блоці.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Error block</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>block</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Print a message</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#39;I execute normally&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Force a failure</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.command</span>: <span style=color:#ae81ff>/bin/false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Never print this</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#39;I never execute, due to the above task failing, :-(&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rescue</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Print when errors</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#39;I caught an error&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Force a failure in middle of recovery! &gt;:-)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.command</span>: <span style=color:#ae81ff>/bin/false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Never print this</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#39;I also never execute :-(&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>always</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Always do this</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;This always executes&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Print a message<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;I execute normally&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Force a failure<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/false&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.003974&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-10-07 14:37:27.522485&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 1, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-10-07 14:37:27.518511&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Print when errors<span style=color:#f92672>]</span> *******************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;I caught an error&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Force a failure in middle of recovery! &gt;:-<span style=color:#f92672>)]</span> *****************************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/false&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.002841&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-10-07 14:37:30.324774&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 1, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-10-07 14:37:30.321933&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Always <span style=color:#66d9ef>do</span> this<span style=color:#f92672>]</span> **********************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;This always executes&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=loop>Loop<a href=#loop class=hanchor arialabel=Anchor>&#8983;</a></h2><p>В ansible є декілька виднів циклів. Розпочнемо з найпростішого циклу по списку</p><h3 id=simple-list>Simple list<a href=#simple-list class=hanchor arialabel=Anchor>&#8983;</a></h3><p>В цьому випадку створюється декілька користувачів (testuser1 i testuser2) які вказані в блоці loop, а замість назви користувача вказується <code>{{ item }}</code>, який при виконані буде замінено назвою користувача</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Add several users</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.user</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>groups</span>: <span style=color:#e6db74>&#34;wheel&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>testuser1</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>testuser2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Add several users<span style=color:#f92672>]</span> *******************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>testuser1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>=</span>testuser2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h3 id=list-of-hashes>List of hashes<a href=#list-of-hashes class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Ось так виглядає цикл по списку хеш мап. Цикл виглядає так само з однією відмінністю що в блоці завдання до <code>{{ item }}</code> додається ще назва ключа з мапи і тоді значення поля name буде мати такий вигляд <code>"{{ item.name }}"</code> а групи <code>"{{ item.groups }}"</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Add several users</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.user</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;{{ item.name }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>groups</span>: <span style=color:#e6db74>&#34;{{ item.groups }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>    - { <span style=color:#f92672>name: &#39;testuser3&#39;, groups</span>: <span style=color:#e6db74>&#39;wheel&#39;</span> }
</span></span><span style=display:flex><span>    - { <span style=color:#f92672>name: &#39;testuser4&#39;, groups</span>: <span style=color:#e6db74>&#39;root&#39;</span> }
</span></span><span style=display:flex><span>  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Add several users<span style=color:#f92672>]</span> *******************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span><span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;testuser3&#39;</span>, <span style=color:#e6db74>&#39;groups&#39;</span>: <span style=color:#e6db74>&#39;wheel&#39;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span><span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;testuser4&#39;</span>, <span style=color:#e6db74>&#39;groups&#39;</span>: <span style=color:#e6db74>&#39;root&#39;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h3 id=register-var-in-loop>Register var in loop<a href=#register-var-in-loop class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Якщо ми використовуємо цикл і хочемо використати <code>register</code> для того щоб зберегти вивід завдання то результат у цьому випадку буде збережено в список.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Register loop output as a variable</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ansible.builtin.shell</span>: <span style=color:#e6db74>&#34;echo {{ item }}&#34;</span><span style=color:#e6db74>2022-10-02</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;one&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;two&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>register</span>: <span style=color:#ae81ff>echo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Print variable</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ansible.builtin.debug</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;{{ echo }}&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;All items completed&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;results&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;changed&#34;</span>: true,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;echo \&#34;one\&#34; &#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.003110&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-10-02 12:00:05.187153&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;invocation&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;module_args&#34;</span>: <span style=color:#e6db74>&#34;echo \&#34;one\&#34;&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;module_name&#34;</span>: <span style=color:#e6db74>&#34;shell&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;one&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;rc&#34;</span>: 0,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-10-02 12:00:05.184043&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;one&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;changed&#34;</span>: true,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;echo \&#34;two\&#34; &#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.002920&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-10-02 12:00:05.245502&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;invocation&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;module_args&#34;</span>: <span style=color:#e6db74>&#34;echo \&#34;two\&#34;&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;module_name&#34;</span>: <span style=color:#e6db74>&#34;shell&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;two&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;rc&#34;</span>: 0,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-10-02 12:00:05.242582&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;two&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=delegate-to>Delegate To<a href=#delegate-to class=hanchor arialabel=Anchor>&#8983;</a></h2><p><code>delegate_to</code> використовується якщо потрібно передати виконання якось з завдань на інший сервер або локально. Наприклад налаштовується сервер а по закінчені він має бути доданий в loadbalancer. Але сам сервер таких прав може не мати тому виконання цього завдання можна передати на локальний сервер який такі права має.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Add server to load balancer</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.command</span>: <span style=color:#ae81ff>echo &#34;Adding to loadbalancer&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>delegate_to</span>: <span style=color:#ae81ff>127.0.0.1</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Add server to load balancer<span style=color:#f92672>]</span> *********************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>3.92.61.18 -&gt; 127.0.0.1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=failed-when>Failed when<a href=#failed-when class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Якщо ansible виконує shell скрипт то не завжди може коректно визначити чи завдання завершилось успішно чи ні, в таких випадках можна використати параметр <code>failed_when</code> в якому буде описано в яких випадках вважати завдання не успішно завершеним</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Making sure the Physical Memory more than 2gb</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ansible.builtin.shell</span>: <span style=color:#e6db74>&#34;cat /proc/meminfo|grep -i memtotal|awk &#39;{print $2/1024/1024}&#39;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>register</span>: <span style=color:#ae81ff>memory</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>failed_when</span>: <span style=color:#e6db74>&#34;memory.stdout|float &lt; 2&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Making sure the Physical Memory more than 2gb<span style=color:#f92672>]</span> ***************************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#e6db74>&#34;cat /proc/meminfo|grep -i memtotal|awk &#39;{print </span>$2<span style=color:#e6db74>/1024/1024}&#39;&#34;</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.006063&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-10-07 14:46:37.761174&#34;</span>, <span style=color:#e6db74>&#34;failed_when_result&#34;</span>: true, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 0, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-10-07 14:46:37.755111&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;0.943119&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;0.943119&#34;</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=ignore-errors>Ignore Errors<a href=#ignore-errors class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Якщо в нас є завдання в яких ми очікуємо що може бути помилка але всерівно хочемо продовжити виконання то можна додати параметр <code>ignore_errors: yes</code> і виконання playbook продовжиться.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Do not count this as a failure</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ansible.builtin.command</span>: <span style=color:#ae81ff>/bin/false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ignore_errors</span>: <span style=color:#66d9ef>yes</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ansible-playbook -i inventory main.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Update web servers<span style=color:#f92672>]</span> ******************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************************************************************
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host 3.92.61.18 is using the discovered Python interpreter at /usr/bin/python3.7, but future
</span></span><span style=display:flex><span>installation of another Python interpreter could change the meaning of that path. See https://docs.ansible.com/ansible-
</span></span><span style=display:flex><span>core/2.13/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Do not count this as a failure<span style=color:#f92672>]</span> ******************************************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>3.92.61.18<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/false&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.002920&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2022-10-07 14:43:48.380284&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 1, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2022-10-07 14:43:48.377364&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>...ignoring
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************
</span></span><span style=display:flex><span>3.92.61.18                 : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h2 id=video>Video<a href=#video class=hanchor arialabel=Anchor>&#8983;</a></h2><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/k74GIVucO_Y style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://mpostument.com/ua/2022/10/15/ansible-role/><span class=button__icon>←</span>
<span class=button__text>Ansible Role</span></a></span>
<span class="button next"><a href=https://mpostument.com/ua/2022/09/27/ansible-inventory/><span class=button__text>Ansible Inventory</span>
<span class=button__icon>→</span></a></span></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mpostument-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>