<!doctype html><html lang=ua>
<head>
<title>WaitGroup :: Maksym Postument</title><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="What is WaitGroup and how to use it">
<meta name=keywords content="Go,Golang,Multithreading">
<meta name=robots content="noodp">
<link rel=canonical href=/ua/2022/02/02/wait-groups/>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SBRJXS94DC"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SBRJXS94DC",{anonymize_ip:!1})}</script>
<link rel=stylesheet href=/assets/style.css>
<link rel=stylesheet href=/assets/blue.css>
<link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=/img/favicon/blue.png>
<meta name=twitter:card content="summary">
<meta name=twitter:site content="mpostument.com">
<meta name=twitter:creator content="Maks_Postument">
<meta property="og:locale" content="ua">
<meta property="og:type" content="article">
<meta property="og:title" content="WaitGroup">
<meta property="og:description" content="What is WaitGroup and how to use it">
<meta property="og:url" content="/ua/2022/02/02/wait-groups/">
<meta property="og:site_name" content="Maksym Postument">
<meta property="og:image" content="https://i.imgur.com/VQH6HVs.jpg">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:section" content="Devops">
<meta property="article:section" content="Golang">
<meta property="article:published_time" content="2022-02-02 20:58:30 +0200 +0200">
<p align=center style=background-color:#23b0ff> Sign up for my <a href=https://tinyletter.com/mpostument>email newsletter</a> or use this <a href=/index.xml>RSS feed</a> to get notified of new blog posts.</p></head><body class=blue>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/ua>
<div class=logo>
mpostument.com
</div></a>
</div><div class=menu-trigger>menu</div></div><nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/ua>Home</a></li><li><a href=/ua/categories/>Categories</a></li><li><a href=/ua/tags/>Tags</a></li><div class=spacer></div><ul class=language-selector>
<ul class=language-selector-current>
<li>Ukraine ▾</li></ul><ul class="language-selector__more hidden">
<li><a href=/>English</a></li><li><a href=/ua/>Ukraine</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile">
<li><a href=/ua>Home</a></li><li><a href=/ua/categories/>Categories</a></li><li><a href=/ua/tags/>Tags</a></li><hr>
<li>
<a href=/>English</a>
</li><li>
<a href=/ua/>Ukraine</a>
</li></ul></nav></header><div class=content>
<div class=post>
<h1 class=post-title>
<a href=/ua/2022/02/02/wait-groups/>WaitGroup</a></h1><div class=post-meta>
<span class=post-date>
2022-02-02
</span>
<span class=post-author>:: Maksym Postument</span>
<span class=post-reading-time>:: 2 min read (372 words)</span>
</div><span class=post-tags>
#<a href=/ua/tags/go/>Go</a>&nbsp;
#<a href=/ua/tags/multithreading/>Multithreading</a>&nbsp;
</span>
<img src=https://i.imgur.com/VQH6HVs.jpg class=post-cover alt=WaitGroup title="Cover Image">
<div class=post-content><div>
<p>Привіт!</p><p>Сьогодні розглянемо <code>WaitGroup</code> в golang і подивимось як їх застосовувати на прикладі програми для пошуку файлів.</p><p><code>WaitGroup</code> очікує завершення go рутин. Основна go рутина викликає метод <code>Add</code>, і потім кожна go рутина викликає метод <code>Done</code> коли рутина завершується.</p><p>Розпочнемо з методу <code>findFile</code>. В ньому читаємо всі файли й директорії в заданій папці. Проходимось циклом по них і якщо назва файлу який ми шукаємо збігається з назвою файлу з циклу то додаємо його в список matches. Якщо ж це директорія, то рекурсивно викликаємо пошук в ній</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;path/filepath&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matches</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>findFile</span>(<span style=color:#a6e22e>root</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>filename</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Searching in&#34;</span>, <span style=color:#a6e22e>root</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>files</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadDir</span>(<span style=color:#a6e22e>root</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>files</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>(), <span style=color:#a6e22e>filename</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>matches</span> = append(<span style=color:#a6e22e>matches</span>, <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>root</span>, <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>()))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>IsDir</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>findFile</span>(<span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>root</span>, <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>()), <span style=color:#a6e22e>filename</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>findFile</span>(<span style=color:#e6db74>&#34;/var/&#34;</span>, <span style=color:#e6db74>&#34;secret.txt&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>matches</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Matched&#34;</span>, <span style=color:#a6e22e>file</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Пошук працює, але займає багато часу. Пришвидшити його можна за допомогою go рутин. Для цього потрібно додати слово <code>go</code> перед викликом методу <code>findFile</code> і перед рекурсивним викликом. Але в такому випадку пошук не спрацює оскільки скрипт одразу завершить роботу, оскільки немає нічого, щоб чекало на виконання всіх рутин. Саме для цього можна застосувати WaitGroup. Скрипт завершиться тільки тоді коли всі go рутини викличуть метод Done.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;path/filepath&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matches</span>   []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>waitGroup</span> = <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lock</span>      = <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>{}
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>findFile</span>(<span style=color:#a6e22e>root</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>filename</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Searching in&#34;</span>, <span style=color:#a6e22e>root</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>files</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadDir</span>(<span style=color:#a6e22e>root</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>files</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>(), <span style=color:#a6e22e>filename</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>matches</span> = append(<span style=color:#a6e22e>matches</span>, <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>root</span>, <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>()))
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>IsDir</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>waitGroup</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>findFile</span>(<span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>root</span>, <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>()), <span style=color:#a6e22e>filename</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>waitGroup</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>waitGroup</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>findFile</span>(<span style=color:#e6db74>&#34;/var/&#34;</span>, <span style=color:#e6db74>&#34;secret.txt&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>waitGroup</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>matches</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Matched&#34;</span>, <span style=color:#a6e22e>file</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Тут добавилось декілька речей. В методі <code>findFile</code> перед додавання назв файлів в список добавився lock. Для того, щоб go рутини не перезаписували дані. Інше що добавилось це <code>waitGroup</code>. Перед кожним викликом <code>go</code> рутини добавився виклик <code>waitGroup.Add(1</code>), і по закінченні <code>go</code> рутини викликається <code>waitGroup.Done()</code>. А в методі <code>main</code> викликається метод <code>waitGroup.Wait()</code> який і буде чекати доки всі <code>go</code> рутини завершують роботу. І після цього буде виведено список усіх файлів.</p></div></div><div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div><div class=pagination__buttons>
<span class="button previous">
<a href=/ua/2022/02/14/sorted-squared-array/>
<span class=button__icon>←</span>
<span class=button__text>Sorted Squared Array</span>
</a>
</span>
<span class="button next">
<a href=/ua/2022/01/31/rwlock/>
<span class=button__text>Read and Write lock in Go</span>
<span class=button__icon>→</span>
</a>
</span>
</div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mpostument-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div></div><footer class=footer>
<div class=footer__inner>
<div class=copyright>
<span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script>
<script src=/assets/languageSelector.js></script>
</div></body></html>