<!doctype html><html lang=ua><head><title>Ebs Auto Resize :: Maksym Postument</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Автоматичний ресайз AWS EBS пристроїв з golang"><meta name=keywords content="Go,Devops,AWS,Golang,Ec2,Ebs"><meta name=robots content="noodp"><link rel=canonical href=https://mpostument.com/ua/programming/golang/ebs-auto-resize/><script async src="https://www.googletagmanager.com/gtag/js?id=G-SBRJXS94DC"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SBRJXS94DC",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://mpostument.com/styles.css><link rel="shortcut icon" href=https://mpostument.com/img/theme-colors/blue.png><link rel=apple-touch-icon href=https://mpostument.com/img/theme-colors/blue.png><meta name=twitter:card content="summary"><meta name=twitter:site content="mpostument.com"><meta name=twitter:creator content="Maks_Postument"><meta property="og:locale" content="ua"><meta property="og:type" content="article"><meta property="og:title" content="Ebs Auto Resize"><meta property="og:description" content="Автоматичний ресайз AWS EBS пристроїв з golang"><meta property="og:url" content="https://mpostument.com/ua/programming/golang/ebs-auto-resize/"><meta property="og:site_name" content="Maksym Postument"><meta property="og:image" content="https://i.imgur.com/ErqKnk5.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="Devops"><meta property="article:section" content="Golang"><meta property="article:section" content="AWS"><meta property="article:published_time" content="2021-02-06 18:14:40 +0200 +0200"><p align=center style=background-color:#23b0ff>Sign up for my <a href=https://tinyletter.com/mpostument>email
newsletter</a> or use this <a href=/index.xml>RSS feed</a>. This is the best way to stay up-to-date with my latest content. Thank you for your continued support!</p><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8633398301520801" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/algoliasearch@4.14.2/dist/algoliasearch-lite.umd.js></script>
<script src=https://cdn.jsdelivr.net/npm/@algolia/autocomplete-js></script>
<script src=https://cdn.jsdelivr.net/npm/@algolia/autocomplete-preset-algolia></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@algolia/autocomplete-theme-classic><div id=autocomplete></div><script>var searchClient=algoliasearch("8HJOK7X4MI","a882cdf8954678175d442905d08d8926");const{autocomplete}=window["@algolia/autocomplete-js"],{getAlgoliaResults}=window["@algolia/autocomplete-preset-algolia"];autocomplete({container:"#autocomplete",placeholder:"Search",getSources({query:e}){return[{sourceId:"title",getItems(){return getAlgoliaResults({searchClient,queries:[{indexName:"mpostument",query:e,params:{hitsPerPage:5,attributesToSnippet:["title:15","description:35"],snippetEllipsisText:"…"}}]})},templates:{item({item:e,components:t,html:n}){return n`<div class="aa-ItemWrapper">
                            <div class="aa-ItemContent">
                              <div class="aa-ItemContentBody">
                                <div class="aa-ItemContentTitle">
                                  ${t.Highlight({hit:e,attribute:"title"})}
                                </div>
                                <div class="aa-ItemContentDescription">
                                  ${t.Snippet({hit:e,attribute:"description"})}
                                </div>
                              </div>
                            </div>
                          </div>`}},getItemUrl({item:e}){return e.href},onSelect({item:e}){window.location.href=e.href}}]}})</script></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/ua><div class=logo>mpostument.com</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/ua>Home</a></li><li><a href=/ua/programming/>Programming</a></li><li><a href=/ua/tags/>Tags</a></li><li><a href=/ua/categories/>Categories</a></li><hr><li><a href=https://mpostument.com/>English</a></li><li><a href=https://mpostument.com/ua/>Ukraine</a></li></ul></li></ul><ul class="menu menu--desktop menu--language-selector"><li class=menu__trigger>Ukraine&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://mpostument.com/>English</a></li><li><a href=https://mpostument.com/ua/>Ukraine</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/ua>Home</a></li><li><a href=/ua/programming/>Programming</a></li><li><a href=/ua/tags/>Tags</a></li><li><a href=/ua/categories/>Categories</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://mpostument.com/ua/programming/golang/ebs-auto-resize/>Ebs Auto Resize</a></h1><div class=post-meta><time class=post-date>2021-02-06</time><span class=post-author>Maksym Postument</span><span class=post-reading-time>7 min read (1282 words)</span></div><span class=post-tags>#<a href=https://mpostument.com/ua/tags/go/>Go</a>&nbsp;
#<a href=https://mpostument.com/ua/tags/devops/>Devops</a>&nbsp;
#<a href=https://mpostument.com/ua/tags/aws/>AWS</a>&nbsp;</span>
<img src=https://i.imgur.com/ErqKnk5.png class=post-cover alt="Ebs Auto Resize" title="Cover Image"><div class=post-content><div><p>Привіт!</p><p>Сьогодні зробимо скрипт для автоматичного ресайзу EBS volume за допомогою golang i AWS SDK version 2.
Для того щоб це зробити потрібно виконати декілька кроків, отримати список волюмів, відфільтрувати тих в яких кількість вільної пам&rsquo;яті менший ніж трешхолд, знайти ebs id який відповідає даному волюму. Зробити ресайз на заданий процент і збільшити розмір диску на файловій системі.</p><p>Розпочну з структури в якій буде зберігатись вся інформація по диску та вкажу всі потрібні імпорти.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;math&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os/exec&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;regexp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/aws&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/config&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/service/ec2&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/service/ec2/types&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/aws/smithy-go&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/mvisonneau/go-ebsnvme/pkg/ebsnvme&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/shirou/gopsutil/v3/disk&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DiskData</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VolumeID</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>DeviceName</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MountPoint</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>TotalUsed</span>  <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>TotalSpace</span> <span style=color:#66d9ef>uint64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>FsType</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VolumeSize</span> <span style=color:#66d9ef>int32</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Перший метод запише усю потрібну інформацію про диски в <code>DiskData</code> структуру. Для того щоб отримати інформацію з системи буде використовуватись <code>gopsutil</code>. Якщо ж в системі диск відображається як <code>nvme</code> його треба привести до стандартного запису (/dev/sda) за яким можна буде фільтрувати потрібний диск. Але тільки цього буде не достатньо оскільки диски на різних серверах можуть бути змонтовані під однаковим іменем. Саме для цього буде потрібен instance id, який можна отримати з метаданих сервера.</p><p>Спочатку отримую список усіх дисків за допомогою <code>disk.Partitions(false)</code>, також створюю ec2client i отримую instanceID. Ці методи будуть створені пізніше. Далі циклом проходжу по усіх дисках і перевіряю чи <code>nvme</code> є в назві диску і за допомогою <code>ebsnvme</code> отримую назву в форматі /dev/sda. І зберігаю результат в <code>ebsDevice</code>. Якщо ж ні то міняю назву диска з <code>xvd</code> на <code>sd</code>. Саме такий формат потрібен для aws. Тепер можна зробити запит до aws для того щоб отримати volumeID. За допомогою метода <code>Usage</code> отримую дані по використанню диска та записую в <code>DiskData</code> структуру і добавлю в список, який в кінці метода повертається.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>filterDisks</span>() ([]<span style=color:#a6e22e>DiskData</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>parts</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>Partitions</span>(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getEc2Client</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>instanceID</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getInstanceID</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>diskData</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>DiskData</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>parts</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ebsDevice</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Device</span>, <span style=color:#e6db74>&#34;nvme&#34;</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>volumeMapping</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ebsnvme</span>.<span style=color:#a6e22e>ScanDevice</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Device</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ebsDevice</span> = <span style=color:#a6e22e>volumeMapping</span>.<span style=color:#a6e22e>Name</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ebsDevice</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Replace</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Device</span>, <span style=color:#e6db74>&#34;xvd&#34;</span>, <span style=color:#e6db74>&#34;sd&#34;</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>filter</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ec2</span>.<span style=color:#a6e22e>DescribeVolumesInput</span>{<span style=color:#a6e22e>Filters</span>: []<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>Filter</span>{
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;attachment.device&#34;</span>),
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Values</span>: []<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>ebsDevice</span>,
</span></span><span style=display:flex><span>				},
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;attachment.instance-id&#34;</span>),
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Values</span>: []<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>instanceID</span>,
</span></span><span style=display:flex><span>				},
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>volumeInfo</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>DescribeVolumes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>filter</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>usage</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>Usage</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Mountpoint</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>disk</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>DiskData</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>VolumeID</span>:   <span style=color:#f92672>*</span><span style=color:#a6e22e>volumeInfo</span>.<span style=color:#a6e22e>Volumes</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>VolumeId</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>DeviceName</span>: <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Device</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>MountPoint</span>: <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Mountpoint</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>TotalUsed</span>:  <span style=color:#a6e22e>usage</span>.<span style=color:#a6e22e>UsedPercent</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>TotalSpace</span>: <span style=color:#a6e22e>usage</span>.<span style=color:#a6e22e>Total</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>VolumeSize</span>: <span style=color:#a6e22e>volumeInfo</span>.<span style=color:#a6e22e>Volumes</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Size</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>FsType</span>:     <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Fstype</span>,
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>diskData</span> = append(<span style=color:#a6e22e>diskData</span>, <span style=color:#a6e22e>disk</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>diskData</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Потрібно створити методи які використовуються filterDisks, почну з getInstanceID. Цей метод робить запит до метаданих ec2 інстанса і отримує у відповідь InstanceID.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getInstanceID</span>() (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LoadDefaultConfig</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>imds</span>.<span style=color:#a6e22e>NewFromConfig</span>(<span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>instanceID</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>GetInstanceIdentityDocument</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>imds</span>.<span style=color:#a6e22e>GetInstanceIdentityDocumentInput</span>{})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>instanceID</span>.<span style=color:#a6e22e>InstanceID</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>getEc2Client</code> з метаданих отримує назву регіону та повертає ec2 client.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getEc2Client</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>ec2</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LoadDefaultConfig</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>imds</span>.<span style=color:#a6e22e>NewFromConfig</span>(<span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>region</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>GetRegion</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>imds</span>.<span style=color:#a6e22e>GetRegionInput</span>{})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Region</span> = <span style=color:#a6e22e>region</span>.<span style=color:#a6e22e>Region</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ec2</span>.<span style=color:#a6e22e>NewFromConfig</span>(<span style=color:#a6e22e>cfg</span>), <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Залишилось вирахувати на скільки збільшити розмір диска.
В цьому методі переводиться розмір диска отриманий в <code>filterDisks</code> з байтів в гігабайт та визначається новий розмір диска.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>findNewSize</span>(<span style=color:#a6e22e>oldSize</span> <span style=color:#66d9ef>uint64</span>, <span style=color:#a6e22e>increasePercent</span> <span style=color:#66d9ef>float64</span>) <span style=color:#66d9ef>int32</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gbSize</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>oldSize</span>) <span style=color:#f92672>/</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Pow</span>(<span style=color:#ae81ff>1024</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newSize</span> <span style=color:#f92672>:=</span> ((<span style=color:#a6e22e>gbSize</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>increasePercent</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>100</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>gbSize</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> int32(<span style=color:#a6e22e>newSize</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Сам ресайз буде відбуватись в три кроки:</p><ol><li><p>Збільшити розмір ebs</p></li><li><p>Викликати grow part для того щоб збільшити розмір партишина якщо він існує.</p></li><li><p>Збільшити розмір файлової системи.</p></li></ol><p>Розпочну з першого кроку.<br>В цьому методі я отримую ec2 client за допомогою метода <code>getEc2Client</code> та роблю <code>ModifyVolume</code> запит до AWS. Тут важливо відфільтрувати певні помилки.
Перша це <code>VolumeModificationRateExceeded</code>. AWS дозволяє робити ресайз 1 раз в 6 годин, тому я не хочу щоб скрипт завершувався якщо ліміт перевищено, а перевіряв інші доступні диски.</p><p>Наступна помилка це <code>IncorrectModificationState</code>. Після ресайзу диску в нього змінюється статут на <code>Optimizing</code>, в такому випадку я теж не хочу завершувати роботу, а перейти до наступного диску.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ebsResize</span>(<span style=color:#a6e22e>newSize</span> <span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>volumeID</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getEc2Client</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting resize of ebs volume&#34;</span>, <span style=color:#a6e22e>volumeID</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>input</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ec2</span>.<span style=color:#a6e22e>ModifyVolumeInput</span>{<span style=color:#a6e22e>VolumeId</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>volumeID</span>, <span style=color:#a6e22e>Size</span>: <span style=color:#a6e22e>newSize</span>}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>ModifyVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>input</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ae</span> <span style=color:#a6e22e>smithy</span>.<span style=color:#a6e22e>APIError</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>As</span>(<span style=color:#a6e22e>err</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ae</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>ae</span>.<span style=color:#a6e22e>ErrorCode</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;VolumeModificationRateExceeded&#34;</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Ebs was already resized, wait for 6 hours before next resize&#34;</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errVolumeRetryLater</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;IncorrectModificationState&#34;</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>ae</span>.<span style=color:#a6e22e>ErrorMessage</span>())
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errVolumeRetryLater</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>waitForEbsResize</span>(<span style=color:#a6e22e>volumeID</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Після того як ресайз запущено потрібно дочекатись коли він завершиться, для цього я створю наступний метод <code>waitForEbsResize</code>.
Метод <code>waitForEbsResize</code> за допомогою ec2 client робить запит типу <code>DescribeVolumesModifications</code> і перевіряє чи статус диску <code>modifying</code>. Якщо так чекаю 15 секунд і запускаю ще раз метод рекурсивно.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>waitForEbsResize</span>(<span style=color:#a6e22e>volumeID</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getEc2Client</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>input</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ec2</span>.<span style=color:#a6e22e>DescribeVolumesModificationsInput</span>{<span style=color:#a6e22e>VolumeIds</span>: []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>volumeID</span>}}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>status</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>DescribeVolumesModifications</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>input</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>VolumesModifications</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>ModificationState</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;modifying&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Ebs modification in progress. Waiting for 15 second&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>15</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>waitForEbsResize</span>(<span style=color:#a6e22e>volumeID</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Тепер можна приступити до 2 кроку <code>growPartition</code>.</p><p>Потрібно визначити чи є партішин, якщо його немає grow part викликати не потрібно. В залежності від того який тип диску я так і буду визначати чи є партішин. Потрібно зробити декілька перевірок. Перша чи в назві немає цифр. Якщо їх немає то це не партішин і робити growpart не потрібно. Наступна перевірка для nvme пристроїв. Якщо в назві є символ p отже це партішин. Наприклад <code>/dev/nvme1n1</code> - диск і <code>/dev/nvme0n1p1</code> - партішин. І останній випадок якщо є xvd в назві пристрою, ця перевірка лише для того щоб відфільтрувати звичайний ebs від nvme. І в залежності від кожного випадку викликається grow part для ebs - <code>growpart /dev/xvdf 1</code> і для nvme - <code>growpart /dev/nvme0n1 1</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>growPartition</span>(<span style=color:#a6e22e>partition</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting growpart for&#34;</span>, <span style=color:#a6e22e>partition</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Cmd</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>LastIndex</span>(<span style=color:#a6e22e>partition</span>, <span style=color:#e6db74>&#34;p&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>isLetter</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>MustCompile</span>(<span style=color:#e6db74>`^/dev/+[a-zA-Z]+$`</span>).<span style=color:#a6e22e>MatchString</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isLetter</span>(<span style=color:#a6e22e>partition</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Grow partition for&#34;</span>, <span style=color:#a6e22e>partition</span>, <span style=color:#e6db74>&#34;not required&#34;</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cmd</span> = <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;growpart&#34;</span>, <span style=color:#a6e22e>partition</span>[:<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>partition</span>[<span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>:])
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Run</span>()
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>partition</span>, <span style=color:#e6db74>&#34;xvd&#34;</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>re</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>MustCompile</span>(<span style=color:#e6db74>`\D+`</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>re</span>.<span style=color:#a6e22e>FindString</span>(<span style=color:#a6e22e>partition</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cmd</span> = <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;growpart&#34;</span>, <span style=color:#a6e22e>m</span>, <span style=color:#a6e22e>partition</span>[len(<span style=color:#a6e22e>m</span>):])
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Run</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Останні етап це збільшити розмір файлової системи. Як буде відбуватись ресайз залежить від файлової системи.
Якщо це xfs то викликається <code>xfs_growfs</code> в інших випадках це <code>resize2fs</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>fsResize</span>(<span style=color:#a6e22e>filesystem</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>mountPoint</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>partition</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting system volume resize for&#34;</span>, <span style=color:#a6e22e>partition</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Cmd</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>filesystem</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;xfs&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cmd</span> = <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;xfs_growfs&#34;</span>, <span style=color:#e6db74>&#34;-d&#34;</span>, <span style=color:#a6e22e>mountPoint</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cmd</span> = <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;resize2fs&#34;</span>, <span style=color:#a6e22e>partition</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Run</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Тепер залишилось викликати всі методи в правильному порядку:</p><ol><li><p>Отримую список дисків</p></li><li><p>Йду циклом по усіх дисках. Якщо умова <code>disk.TotalUsed &lt; 70</code> false то ресайз не потрібен.</p></li><li><p>Вираховую новий розмір диску</p></li><li><p>Викликаю ebsResize</p></li><li><p>Викликаю growPartition</p></li><li><p>Викликаю fsResize</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>disksInfo</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>filterDisks</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>disk</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>disksInfo</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>TotalUsed</span> &lt; <span style=color:#ae81ff>70</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Resize for&#34;</span>, <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>DeviceName</span>, <span style=color:#e6db74>&#34;not required&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting resize of&#34;</span>, <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>DeviceName</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>newSize</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>findNewSize</span>(<span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>TotalSpace</span>, <span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ebsResize</span>(int32(<span style=color:#a6e22e>newSize</span>), <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>VolumeID</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>errVolumeRetryLater</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>growPartition</span>(<span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>DeviceName</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fsResize</span>(<span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>FsType</span>, <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>MountPoint</span>, <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>DeviceName</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Через декілька секунд диск має новий розмір.</p></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mpostument-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>