<!doctype html><html lang=ua><head><title>WaitGroup :: Maksym Postument</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="What is WaitGroup and how to use it"><meta name=keywords content="Go,Golang,Multithreading"><meta name=robots content="noodp"><link rel=canonical href=https://mpostument.com/ua/programming/golang/wait-groups/><script async src="https://www.googletagmanager.com/gtag/js?id=G-SBRJXS94DC"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SBRJXS94DC",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://mpostument.com/styles.css><link rel="shortcut icon" href=https://mpostument.com/img/theme-colors/blue.png><link rel=apple-touch-icon href=https://mpostument.com/img/theme-colors/blue.png><meta name=twitter:card content="summary"><meta name=twitter:site content="mpostument.com"><meta name=twitter:creator content="Maks_Postument"><meta property="og:locale" content="ua"><meta property="og:type" content="article"><meta property="og:title" content="WaitGroup"><meta property="og:description" content="What is WaitGroup and how to use it"><meta property="og:url" content="https://mpostument.com/ua/programming/golang/wait-groups/"><meta property="og:site_name" content="Maksym Postument"><meta property="og:image" content="https://i.imgur.com/VQH6HVs.jpg"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="Devops"><meta property="article:section" content="Golang"><meta property="article:published_time" content="2022-02-02 20:58:30 +0200 +0200"><p align=center style=background-color:#23b0ff>Sign up for my <a href=https://tinyletter.com/mpostument>email
newsletter</a> or use this <a href=/index.xml>RSS feed</a>. This is the best way to stay up-to-date with my latest content. Thank you for your continued support!</p><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8633398301520801" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/algoliasearch@4.14.2/dist/algoliasearch-lite.umd.js></script>
<script src=https://cdn.jsdelivr.net/npm/@algolia/autocomplete-js></script>
<script src=https://cdn.jsdelivr.net/npm/@algolia/autocomplete-preset-algolia></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@algolia/autocomplete-theme-classic><div id=autocomplete></div><script>var searchClient=algoliasearch("8HJOK7X4MI","a882cdf8954678175d442905d08d8926");const{autocomplete}=window["@algolia/autocomplete-js"],{getAlgoliaResults}=window["@algolia/autocomplete-preset-algolia"];autocomplete({container:"#autocomplete",placeholder:"Search",getSources({query:e}){return[{sourceId:"title",getItems(){return getAlgoliaResults({searchClient,queries:[{indexName:"mpostument",query:e,params:{hitsPerPage:5,attributesToSnippet:["title:15","description:35"],snippetEllipsisText:"…"}}]})},templates:{item({item:e,components:t,html:n}){return n`<div class="aa-ItemWrapper">
                            <div class="aa-ItemContent">
                              <div class="aa-ItemContentBody">
                                <div class="aa-ItemContentTitle">
                                  ${t.Highlight({hit:e,attribute:"title"})}
                                </div>
                                <div class="aa-ItemContentDescription">
                                  ${t.Snippet({hit:e,attribute:"description"})}
                                </div>
                              </div>
                            </div>
                          </div>`}},getItemUrl({item:e}){return e.href},onSelect({item:e}){window.location.href=e.href}}]}})</script></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/ua><div class=logo>mpostument.com</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/ua>Home</a></li><li><a href=/ua/programming/>Programming</a></li><li><a href=/ua/tags/>Tags</a></li><li><a href=/ua/categories/>Categories</a></li><hr><li><a href=https://mpostument.com/>English</a></li><li><a href=https://mpostument.com/ua/>Ukraine</a></li></ul></li></ul><ul class="menu menu--desktop menu--language-selector"><li class=menu__trigger>Ukraine&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://mpostument.com/>English</a></li><li><a href=https://mpostument.com/ua/>Ukraine</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/ua>Home</a></li><li><a href=/ua/programming/>Programming</a></li><li><a href=/ua/tags/>Tags</a></li><li><a href=/ua/categories/>Categories</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://mpostument.com/ua/programming/golang/wait-groups/>WaitGroup</a></h1><div class=post-meta><time class=post-date>2022-02-02 ::</time>
<span class=post-author>Maksym Postument</span>
<span class=post-reading-time>:: 2 min read (372 words)</span></div><span class=post-tags>#<a href=https://mpostument.com/ua/tags/go/>Go</a>&nbsp;
#<a href=https://mpostument.com/ua/tags/multithreading/>Multithreading</a>&nbsp;</span>
<img src=https://i.imgur.com/VQH6HVs.jpg class=post-cover alt=WaitGroup title="Cover Image"><div class=post-content><div><p>Привіт!</p><p>Сьогодні розглянемо <code>WaitGroup</code> в golang і подивимось як їх застосовувати на прикладі програми для пошуку файлів.</p><p><code>WaitGroup</code> очікує завершення go рутин. Основна go рутина викликає метод <code>Add</code>, і потім кожна go рутина викликає метод <code>Done</code> коли рутина завершується.</p><p>Розпочнемо з методу <code>findFile</code>. В ньому читаємо всі файли й директорії в заданій папці. Проходимось циклом по них і якщо назва файлу який ми шукаємо збігається з назвою файлу з циклу то додаємо його в список matches. Якщо ж це директорія, то рекурсивно викликаємо пошук в ній</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;path/filepath&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matches</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>findFile</span>(<span style=color:#a6e22e>root</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>filename</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Searching in&#34;</span>, <span style=color:#a6e22e>root</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>files</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadDir</span>(<span style=color:#a6e22e>root</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>files</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>(), <span style=color:#a6e22e>filename</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>matches</span> = append(<span style=color:#a6e22e>matches</span>, <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>root</span>, <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>()))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>IsDir</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>findFile</span>(<span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>root</span>, <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>()), <span style=color:#a6e22e>filename</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>findFile</span>(<span style=color:#e6db74>&#34;/var/&#34;</span>, <span style=color:#e6db74>&#34;secret.txt&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>matches</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Matched&#34;</span>, <span style=color:#a6e22e>file</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Пошук працює, але займає багато часу. Пришвидшити його можна за допомогою go рутин. Для цього потрібно додати слово <code>go</code> перед викликом методу <code>findFile</code> і перед рекурсивним викликом. Але в такому випадку пошук не спрацює оскільки скрипт одразу завершить роботу, оскільки немає нічого, щоб чекало на виконання всіх рутин. Саме для цього можна застосувати WaitGroup. Скрипт завершиться тільки тоді коли всі go рутини викличуть метод Done.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;path/filepath&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matches</span>   []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>waitGroup</span> = <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lock</span>      = <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>{}
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>findFile</span>(<span style=color:#a6e22e>root</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>filename</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Searching in&#34;</span>, <span style=color:#a6e22e>root</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>files</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadDir</span>(<span style=color:#a6e22e>root</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>files</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>(), <span style=color:#a6e22e>filename</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>matches</span> = append(<span style=color:#a6e22e>matches</span>, <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>root</span>, <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>()))
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>IsDir</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>waitGroup</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>findFile</span>(<span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>root</span>, <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Name</span>()), <span style=color:#a6e22e>filename</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>waitGroup</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>waitGroup</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>findFile</span>(<span style=color:#e6db74>&#34;/var/&#34;</span>, <span style=color:#e6db74>&#34;secret.txt&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>waitGroup</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>matches</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Matched&#34;</span>, <span style=color:#a6e22e>file</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Тут добавилось декілька речей. В методі <code>findFile</code> перед додавання назв файлів в список добавився lock. Для того, щоб go рутини не перезаписували дані. Інше що добавилось це <code>waitGroup</code>. Перед кожним викликом <code>go</code> рутини добавився виклик <code>waitGroup.Add(1</code>), і по закінченні <code>go</code> рутини викликається <code>waitGroup.Done()</code>. А в методі <code>main</code> викликається метод <code>waitGroup.Wait()</code> який і буде чекати доки всі <code>go</code> рутини завершують роботу. І після цього буде виведено список усіх файлів.</p></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mpostument-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>