<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Deploy to ec2 with codedship &#183; Maksym Postument</title><meta name=description content="Hi there!
Today I want to show how you can deploy code on AWS EC2 using CodeShip Basic. To do this, I will use the integration of Codeship with AWS CodeDeploy.
CodeShip Configuration First you need to add a repository to CodeShip and go to the Deploy page Add a branch from which code will be deployed to ec2. In my case, the branch is master. Once the branch is added you need to scroll down to the Deployment section."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.74.3"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Deploy to ec2 with codedship"><meta property="og:description" content="Hi there!
Today I want to show how you can deploy code on AWS EC2 using CodeShip Basic. To do this, I will use the integration of Codeship with AWS CodeDeploy.
CodeShip Configuration First you need to add a repository to CodeShip and go to the Deploy page Add a branch from which code will be deployed to ec2. In my case, the branch is master. Once the branch is added you need to scroll down to the Deployment section."><meta property="og:type" content="article"><meta property="og:url" content="/2020/09/16/deploy-to-ec2-with-codeship/"><link rel=stylesheet href=/dist/site.css><link rel=stylesheet href=/dist/syntax.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous></head><body><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-176839804-1','auto');ga('send','pageview');}</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=mpostument.com href=/>mpostument.com</a></h1><a class=button-square href=/index.xml><i class="fa fa-rss"></i></a><a class="button-square button-social hint--top" data-hint=Twitter title=Twitter href=https://twitter.com/Maks_Postument rel=me><i class="fa fa-twitter"></i></a><a class="button-square button-social hint--top" data-hint=Github title=Github href=https://github.com/mpostument rel=me><i class="fa fa-github-alt"></i></a><a class="button-square button-social hint--top" data-hint=Email title=Email href=mailto:777rip777@gmail.com><i class="fa fa-envelope"></i></a></div><ul class=site-nav><li class=site-nav-item><a title=About href=/about/>About</a></li><li class=site-nav-item><a title=Home href=/>Home</a></li><li class=site-nav-item><a title=Projects href=/projects/>Projects</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Deploy to ec2 with codedship</h1><p class=post-date><span>Published <time datetime=2020-09-16 itemprop=datePublished>Wed, Sep 16, 2020</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=https://github.com/mpostument itemprop=url rel=author>Maksym Postument</a></span></span></p><p class="post-reading post-line"><span>4 min</span></p><nav class=LangNav>Language:
<a href=/ua/2020/09/16/deploy-to-ec2-with-codeship/>Ukrainian</a></nav></header><div class="post-content clearfix" itemprop=articleBody><img class=post-featured-image src=https://i.imgur.com/lSqRdnq.jpg?1><p>Hi there!</p><p>Today I want to show how you can deploy code on AWS EC2 using CodeShip Basic.
To do this, I will use the integration of Codeship with AWS CodeDeploy.</p><h2 id=codeship-configuration>CodeShip Configuration</h2><p>First you need to add a repository to CodeShip and go to the Deploy page
<img src=https://i.imgur.com/Zz2v8aZ.png alt=Coeship1></p><p>Add a branch from which code will be deployed to ec2. In my case, the branch is master.
Once the branch is added you need to scroll down to the Deployment section. And select CodeDeploy
<img src=https://i.imgur.com/KVCmUDn.png alt=Codeship2></p><p>The following form will appear immediately
<img src=https://i.imgur.com/rfdRxKl.png alt=CodeshipForm3>
Here you need to enter the Access and Secret Keys of the AWS user who will perform the deployment. The user must have access to s3 and CodeDeploy.
In the region, specify your AWS Region where the application is located. For me it&rsquo;s us-east-1.<br><code>Application</code>, <code>GroupName</code> will need to be created in AWS. The value should be chosen so that it is clear which application will be deployed. <code>S3 Bucket</code> can be as a general bucket where all deployments will be carried out or choose an individual name for one application. In my case it&rsquo;s CodeShipEc2Deployment.<br>And last is <code>Config Name</code> you need to specify the configuration name in CodeDeploy. I will take the standard <code>CodeDeployDefault.AllAtOnce</code>. This means that the deployment will occur at once on all ec2 instances</p><p>Now with CodeShip configuration over and you can start setting up AWS.</p><h2 id=codedeploy-configuration>CodeDeploy Configuration</h2><p>Open CodeDeploy service in AWS.<br><img src=https://i.imgur.com/cTv6l3Y.png alt=CodeDeploy>
In the Deployment section, find Applications<br><img src=https://i.imgur.com/BAZ6E6d.png alt=Applications><br>Click Create Application. Enter the same name as in Codeship in the <code>Application</code> section. Select EC2 as the Compute Platform
<img src=https://i.imgur.com/zAXUxuF.png alt=CreateApplication>
Open the newly created <code>Application</code> and in <code>Deployment Groups</code> select <code>Create Deployment Group</code><br><img src=https://i.imgur.com/5wfA0VU.png alt=DeploymentGroup>
In <code>Deployment group name</code> it is necessary to enter the same name which was specified in CodeShip.
In <code>ServiceRole</code> choose a role that will allow to carry out deployment on ec2. A good example of the role can be found <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/getting-started-create-service-role.html>here</a>.</p><p>In <code>Environment configuration</code>, select ec2. Then you need to specify which tag to use for the ec2 filter. For example it can be Key = Name, Value = ProductionApplication. Here you can use any tags that are on your ec2.<br><img src=https://i.imgur.com/ffGKRQV.png alt=Ec2Filter></p><h2 id=ec2-configuration>Ec2 Configuration</h2><p>Another role will be required for ec2. What accesses it should have can be found <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/instances-ec2-configure.html#instances-ec2-configure-2-verify-instance-profile-permissions>here</a></p><p>Once the role is created, it must be added to the ec2 instance. To do this, select the desired ec2. Right-click and select Attach Role
<img src=https://i.imgur.com/uaIUcyg.png alt=AttachRole><br>Find the role you created above in the list.<br>Now you need to put the CodeDeploy Agent on the ec2 instance. To do this, connect to the server via ssh
<code>ssh -i private_key ec2-user@IP</code>. In my example i am using AmazonLinux. If you have another OS commands can be found <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/codedeploy-agent-operations-install-cli.html>here</a>.</p><ul><li>Download the installation <code>wget https://aws-codedeploy-us-east-1.s3.us-east-1.amazonaws.com/latest/install</code></li><li>Provide permissions <code>sudo chmod + x install</code></li><li>Install agent <code>sudo ./install auto</code></li></ul><p>You can check if the agent is running with the <code>sudo service codedeploy-agent status</code> command. The result should be similar to <code>The AWS CodeDeploy agent is running as PID 32466</code>.<br>You also need to create a folder that will contain the application <code>mkdir /opt/application</code> and give permission to the user. I use ec2-user <code>chown ec2-user:ec2-user /opt/application</code></p><h2 id=deployment-script>Deployment Script</h2><p>At the root of the repository you need to create a file called <code>appspec.yml</code>. Here you can find all options supported by this file - <a href=https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file.html>AWS</a>.</p><p>Here is an example of my file:</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=m>0.0</span><span class=w>
</span><span class=w></span><span class=k>os</span><span class=p>:</span><span class=w> </span>linux<span class=w>
</span><span class=w></span><span class=k>files</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>source</span><span class=p>:</span><span class=w> </span>/<span class=w>
</span><span class=w>    </span><span class=k>destination</span><span class=p>:</span><span class=w> </span>/opt/application<span class=w>
</span><span class=w></span><span class=k>permissions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>object</span><span class=p>:</span><span class=w> </span>/opt/application<span class=w>
</span><span class=w>    </span><span class=k>owner</span><span class=p>:</span><span class=w> </span>ec2-user<span class=w>
</span><span class=w>    </span><span class=k>group</span><span class=p>:</span><span class=w> </span>ec2-user<span class=w>
</span><span class=w></span><span class=k>hooks</span><span class=p>:</span><span class=w>
</span><span class=w>   </span><span class=k>AfterInstall</span><span class=p>:</span><span class=w>
</span><span class=w>   </span>- <span class=k>location</span><span class=p>:</span><span class=w> </span>ops/deploybuild.sh<span class=w>
</span><span class=w>     </span><span class=k>runas</span><span class=p>:</span><span class=w> </span>ec2-user<span class=w>
</span></code></pre></div><p><code>version</code> has a default value and does not need to be changed. 0.0 The only value is supported.<br><code>os</code> can have two values windows or linux, my os is EC2 AmazonLinux, so I choose linux.<br><code>files</code> indicates which files need to be copied to the server during deployment. <code>source: /</code> means copy all files. <code>destination</code> is where to copy.<br>The <code>permissions</code> specifies which permissions should have the files just copied.<br>In the <code>hooks</code> section is the application configuration. I use the <code>AfterInstall</code> hook. This means that the script will run after the <code>Install</code> step. During the <code>Install</code> step, the files are copied to the server. The <code>location</code> specifies which script to run and from its user. <code>runas</code> means that the script will be called on behalf of the user. By default, the code-deploy agent is started from the root and runas at this stage will switch to ec2-user. You can also change the code-deploy agent to run immediately from ec2-user.</p><p>Next we need a deployment script. In the repository, I created the ops folder because the path to my script is <code>- location: ops/deploybuild.sh</code>. And in this folder I created a script <code>deploybuild.sh</code>.
I have a node.js application for which you need to do yarn install and npm start. I will add it to the script</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/usr/bin/env bash
</span><span class=cp></span><span class=nb>cd</span> /opt/application
yarn --ignore-engines
<span class=nb>cd</span> examples/demo-app/
<span class=o>(</span>npm run start-prod<span class=o>)</span><span class=p>&amp;</span>
</code></pre></div><p>This is very basic script to start application. For production is better to use pm2 package to start js application
Now it is necessary to make commit in master branch and codedeploy will start automatically</p></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=/tags/codeship/>Codeship</a>,
<a href=/tags/aws/>AWS</a>,
<a href=/tags/devops/>Devops</a></p><div class=share><a class=icon-twitter href="https://twitter.com/share?text=Deploy%20to%20ec2%20with%20codedship&url=%2f2020%2f09%2f16%2fdeploy-to-ec2-with-codeship%2f" onclick="window.open(this.href,'twitter-share','width=550,height=235');return false;"><i class="fa fa-twitter"></i><span class=hidden>Twitter</span></a>
<a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=%2f2020%2f09%2f16%2fdeploy-to-ec2-with-codeship%2f" onclick="window.open(this.href,'facebook-share','width=580,height=296');return false;"><i class="fa fa-facebook"></i><span class=hidden>Facebook</span></a>
<a class=icon-google-plus href="https://plus.google.com/share?url=%2f2020%2f09%2f16%2fdeploy-to-ec2-with-codeship%2f" onclick="window.open(this.href,'google-plus-share','width=490,height=530');return false;"><i class="fa fa-google-plus"></i><span class=hidden>Google+</span></a></div></footer></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=mpostument.com href=/>mpostument.com</a></h1><a class="button-square button-jump-top js-jump-top" href=#><i class="fa fa-angle-up"></i></a></div><p class=footer-copyright><span>&copy; 2020 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/roryg/ghostwriter>Ghostwriter theme</a> By <a href=http://jollygoodthemes.com>JollyGoodThemes</a></span>
<span>/ <a href=https://github.com/jbub/ghostwriter>Ported</a> to Hugo By <a href=https://github.com/jbub>jbub</a></span></p></div></footer><script src=/js/jquery-1.11.3.min.js></script><script src=/js/jquery.fitvids.js></script><script src=/js/scripts.js></script></body></html>