<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Ebs Auto Resize | mpostument.com</title>
<meta name=keywords content="Go,Devops,AWS,Golang,Ec2,Ebs"><meta name=description content="Automatic AWS EBS resize with golang"><meta name=author content="Maksym Postument"><link rel=canonical href=https://mpostument.com/posts/programming/golang/ebs-auto-resize/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://mpostument.com/favicon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://mpostument.com/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://mpostument.com/favicon/favicon/favicon-32x32.png><link rel=apple-touch-icon href=https://mpostument.com/favicon/apple-touch-icon.png><link rel=mask-icon href=https://mpostument.com/favicon/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://mpostument.com/posts/programming/golang/ebs-auto-resize/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-SBRJXS94DC"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SBRJXS94DC")}</script><meta property="og:title" content="Ebs Auto Resize"><meta property="og:description" content="Automatic AWS EBS resize with golang"><meta property="og:type" content="article"><meta property="og:url" content="https://mpostument.com/posts/programming/golang/ebs-auto-resize/"><meta property="og:image" content="https://i.imgur.com/ErqKnk5.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-06T18:14:40+02:00"><meta property="article:modified_time" content="2021-02-06T18:14:40+02:00"><meta property="og:site_name" content="Maksym Postument"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://i.imgur.com/ErqKnk5.png"><meta name=twitter:title content="Ebs Auto Resize"><meta name=twitter:description content="Automatic AWS EBS resize with golang"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"","item":"https://mpostument.com/posts/"},{"@type":"ListItem","position":2,"name":"","item":"https://mpostument.com/posts/programming/"},{"@type":"ListItem","position":3,"name":"Ebs Auto Resize","item":"https://mpostument.com/posts/programming/golang/ebs-auto-resize/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Ebs Auto Resize","name":"Ebs Auto Resize","description":"Automatic AWS EBS resize with golang","keywords":["Go","Devops","AWS","Golang","Ec2","Ebs"],"articleBody":"Hi there!\nToday we will make a script for automatic resizing of EBS volume using golang and AWS SDK version 2. To do this, I need to perform a few steps: get a list of volumes, filter those volumes in which the amount of free memory is less than the threshold, find the ebs id that corresponds to this volume. Resize by a specified percentage and increase the disk size on the file system.\nI’ll start with the structure in which all the information on the disk will be stored and specify all the necessary imports.\npackage main import ( \"context\" \"errors\" \"io/ioutil\" \"log\" \"math\" \"net/http\" \"os/exec\" \"regexp\" \"strings\" \"time\" \"github.com/aws/aws-sdk-go-v2/aws\" \"github.com/aws/aws-sdk-go-v2/config\" \"github.com/aws/aws-sdk-go-v2/service/ec2\" \"github.com/aws/aws-sdk-go-v2/service/ec2/types\" \"github.com/aws/smithy-go\" \"github.com/mvisonneau/go-ebsnvme/pkg/ebsnvme\" \"github.com/shirou/gopsutil/v3/disk\" ) type DiskData struct { VolumeID string DeviceName string MountPoint string TotalUsed float64 TotalSpace uint64 FsType string VolumeSize int32 } } The first method will write all the necessary information about the disks in the DiskData structure. Gopsutil will be used to retrieve information from the system. If in a system the disk is displayed as nvme it needs to be brought to standard record (/dev/sda) which can be used to filter the necessary ebs volumes. But this alone will not be enough because disks on different servers can be mounted under the same name. To prevent modification of the wrong volume an instance id will be used as an additional condition in a filter. It can be obtained from the server metadata.\nFirst I get a list of all disks using disk.Partitions(false), also I create ec2client and get instanceID from metadata. These methods will be created later. Next, in cycle, i loop through all the disks and check if nvme is in the disk name. If yes with ebsnvme i get disk name in format /dev/sda. And save the result in ebsDevice. If not that I change a disk name from xvd to sd. This is the format required for AWS. Now I can query aws to get the volumeID. Using the Usage method from AWS SDK. I get disk usage and write it to the DiskData.\nfunc filterDisks() ([]DiskData, error) { parts, err := disk.Partitions(false) if err != nil { return nil, err } client, err := getEc2Client() if err != nil { return nil, err } instanceID, err := getInstanceID() if err != nil { return nil, err } diskData := []DiskData{} for _, p := range parts { var ebsDevice string if strings.Contains(p.Device, \"nvme\") { volumeMapping, err := ebsnvme.ScanDevice(p.Device) if err != nil { return nil, err } ebsDevice = volumeMapping.Name } else { ebsDevice = strings.Replace(p.Device, \"xvd\", \"sd\", 1) } filter := \u0026ec2.DescribeVolumesInput{Filters: []types.Filter{ { Name: aws.String(\"attachment.device\"), Values: []string{ ebsDevice, }, }, { Name: aws.String(\"attachment.instance-id\"), Values: []string{ instanceID, }, }, }, } volumeInfo, err := client.DescribeVolumes(context.Background(), filter) if err != nil { return nil, err } usage, _ := disk.Usage(p.Mountpoint) disk := DiskData{ VolumeID: *volumeInfo.Volumes[0].VolumeId, DeviceName: p.Device, MountPoint: p.Mountpoint, TotalUsed: usage.UsedPercent, TotalSpace: usage.Total, VolumeSize: volumeInfo.Volumes[0].Size, FsType: p.Fstype, } diskData = append(diskData, disk) } return diskData, nil } I need to create the methods used by filterDisks, starting from getInstanceID. This method queries the ec2 instance metadata and receives an InstanceID in response.\nfunc getInstanceID() (string, error) { cfg, err := config.LoadDefaultConfig(context.TODO()) if err != nil { return \"\", err } client := imds.NewFromConfig(cfg) instanceID, err := client.GetInstanceIdentityDocument(context.TODO(), \u0026imds.GetInstanceIdentityDocumentInput{}) if err != nil { return \"\", err } return instanceID.InstanceID, nil } getEc2Client gets the region name from the metadata and returns the ec2 client.\nfunc getEc2Client() (*ec2.Client, error) { cfg, err := config.LoadDefaultConfig(context.TODO()) if err != nil { return nil, err } client := imds.NewFromConfig(cfg) region, err := client.GetRegion(context.TODO(), \u0026imds.GetRegionInput{}) if err != nil { return nil, err } cfg.Region = region.Region return ec2.NewFromConfig(cfg), err } What is left is to calculate what amounts of gigabytes disk should be resized. This method converts the disk size obtained in filterDisks from bytes to gigabytes and determines new size of ebs volume.\nfunc findNewSize(oldSize uint64, increasePercent float64) int32 { gbSize := float64(oldSize) / math.Pow(1024, 3) newSize := ((gbSize * increasePercent) / 100) + gbSize return int32(newSize) } The resize will take place in three steps:\nIncrease the size of the ebs\nCall the grow part to increase the size of the particle if it exists.\nIncrease the size of the file system.\nI’ll start with the first step. In this method, I get the ec2 client using the getEc2Client method and make a ModifyVolume request to AWS. Here it is important to filter out certain errors. The first is VolumeModificationRateExceeded. AWS allows you to resize once every 6 hours, so I don’t want the script to fail if the limit is exceeded.\nThe next error is IncorrectModificationState. After resizing the disk, its status changes to Optimizing, in which case I also do not want to quit, and go to the next disk.\nfunc ebsResize(newSize int32, volumeID string) error { client, err := getEc2Client() if err != nil { return err } log.Println(\"Starting resize of ebs volume\", volumeID) input := \u0026ec2.ModifyVolumeInput{VolumeId: \u0026volumeID, Size: newSize} if _, err := client.ModifyVolume(context.Background(), input); err != nil { var ae smithy.APIError if errors.As(err, \u0026ae) { switch ae.ErrorCode() { case \"VolumeModificationRateExceeded\": log.Println(\"Ebs was already resized, wait for 6 hours before next resize\") return errVolumeRetryLater case \"IncorrectModificationState\": log.Println(ae.ErrorMessage()) return errVolumeRetryLater } } else { return err } } err = waitForEbsResize(volumeID) if err != nil { return err } return nil } Once the resize is started, I need to wait for it to complete, so I will create the following method waitForEbsResize. The waitForEbsResize method uses the ec2 client to make a request of type DescribeVolumesModifications and checks whether the status of the disk is modifying. If yes, it waits for 15 seconds and runs the method recursively again.\nfunc waitForEbsResize(volumeID string) error { client, err := getEc2Client() if err != nil { return err } input := \u0026ec2.DescribeVolumesModificationsInput{VolumeIds: []string{volumeID}} status, err := client.DescribeVolumesModifications(context.Background(), input) if status.VolumesModifications[0].ModificationState == \"modifying\" { log.Println(\"Ebs modification in progress. Waiting for 15 second\") time.Sleep(15 * time.Second) if err := waitForEbsResize(volumeID); err != nil { return err } } return nil } Now I can proceed to step 2 growPartition.\nI need to determine if there is a partition, if there is no partition grow part doesn’t need to be executed. Depending on what type of disk I will determine whether there are partitions or no. Several checks are required. The first check if there are no numbers in the device name. If they are not present then it is not partition and it is not required to do grow part. Next check for nvme devices. If there is a symbol p in the name, then it is a partition. For example /dev/nvme1n1 - disk and /dev/nvme0n1p1 - partition. And the last case if there is an xvd in the name of the device, this check only to filter usual ebs devices with numbers in the name. And depending on each case the growpart is executed. For ebs - growpart /dev/xvdf 1 and for nvme - growpart /dev/nvme0n1 1.\nfunc growPartition(partition string) error { log.Println(\"Starting growpart for\", partition) var cmd *exec.Cmd i := strings.LastIndex(partition, \"p\") isLetter := regexp.MustCompile(`^/dev/+[a-zA-Z]+$`).MatchString if isLetter(partition) { log.Println(\"Grow partition for\", partition, \"not required\") } else if i != -1 { cmd = exec.Command(\"growpart\", partition[:i], partition[i+1:]) return cmd.Run() } else if strings.Contains(partition, \"xvd\") { re := regexp.MustCompile(`\\D+`) m := re.FindString(partition) cmd = exec.Command(\"growpart\", m, partition[len(m):]) return cmd.Run() } return nil } The last step is to increase the size of the file system. How the resize will take place depends on the file system. If it is xfs then called xfs_growfs in other cases it is resize2fs.\nfunc fsResize(filesystem string, mountPoint string, partition string) error { log.Println(\"Starting system volume resize for\", partition) var cmd *exec.Cmd if filesystem == \"xfs\" { cmd = exec.Command(\"xfs_growfs\", \"-d\", mountPoint) } else { cmd = exec.Command(\"resize2fs\", partition) } return cmd.Run() } Now it remains to call all the methods in the correct order:\nGet a list of disks\nLoop in a cycle on all of disks. If the condition disk.TotalUsed \u003c 70 is false then resize not required.\nCalculate the new disk size\nCall ebsResize\nCall growPartition\nCall fsResize\nfunc main() { disksInfo, err := filterDisks() if err != nil { log.Fatalln(err) } for _, disk := range disksInfo { if disk.TotalUsed \u003c 70 { log.Println(\"Resize for\", disk.DeviceName, \"not required\") continue } log.Println(\"Starting resize of\", disk.DeviceName) newSize := findNewSize(disk.TotalSpace, 30) if err := ebsResize(int32(newSize), disk.VolumeID); err == errVolumeRetryLater { continue } else if err != nil { log.Fatalln(err) } if err := growPartition(disk.DeviceName); err != nil { log.Fatalln(err) } if err := fsResize(disk.FsType, disk.MountPoint, disk.DeviceName); err != nil { log.Fatalln(err) } } } After a few seconds, the disk has a new size.\n","wordCount":"1449","inLanguage":"en","image":"https://i.imgur.com/ErqKnk5.png","datePublished":"2021-02-06T18:14:40+02:00","dateModified":"2021-02-06T18:14:40+02:00","author":[{"@type":"Person","name":"Maksym Postument"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://mpostument.com/posts/programming/golang/ebs-auto-resize/"},"publisher":{"@type":"Organization","name":"mpostument.com","logo":{"@type":"ImageObject","url":"https://mpostument.com/favicon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://mpostument.com/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://mpostument.com/posts/programming/ title=Programming><span>Programming</span></a></li><li><a href=https://mpostument.com/posts/drawing/ title=Drawing><span>Drawing</span></a></li><li><a href=https://mpostument.com/posts/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://mpostument.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://mpostument.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://mpostument.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://mpostument.com/archives/ title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://mpostument.com/>Home</a>&nbsp;»&nbsp;<a href=https://mpostument.com/posts/></a>&nbsp;»&nbsp;<a href=https://mpostument.com/posts/programming/></a></div><h1 class="post-title entry-hint-parent">Ebs Auto Resize</h1><div class=post-description>Automatic AWS EBS resize with golang</div><div class=post-meta><span title='2021-02-06 18:14:40 +0200 +0200'>February 6, 2021</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1449 words&nbsp;·&nbsp;Maksym Postument&nbsp;|&nbsp;<a href=https://github.com/mpostument/content-mpostument/edit/master/content/posts/programming/golang/ebs-auto-resize.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><a href=https://i.imgur.com/ErqKnk5.png target=_blank rel="noopener noreferrer"><img loading=eager src=https://i.imgur.com/ErqKnk5.png alt></a></figure><div class=post-content><p>Hi there!</p><p>Today we will make a script for automatic resizing of EBS volume using golang and AWS SDK version 2.
To do this, I need to perform a few steps: get a list of volumes, filter those volumes in which the amount of free memory is less than the threshold, find the ebs id that corresponds to this volume. Resize by a specified percentage and increase the disk size on the file system.</p><p>I&rsquo;ll start with the structure in which all the information on the disk will be stored and specify all the necessary imports.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;math&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os/exec&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;regexp&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/aws/aws-sdk-go-v2/aws&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/aws/aws-sdk-go-v2/config&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/aws/aws-sdk-go-v2/service/ec2&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/aws/aws-sdk-go-v2/service/ec2/types&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/aws/smithy-go&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/mvisonneau/go-ebsnvme/pkg/ebsnvme&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/shirou/gopsutil/v3/disk&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DiskData</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>VolumeID</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>DeviceName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>MountPoint</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>TotalUsed</span>  <span class=kt>float64</span>
</span></span><span class=line><span class=cl>	<span class=nx>TotalSpace</span> <span class=kt>uint64</span>
</span></span><span class=line><span class=cl>	<span class=nx>FsType</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>VolumeSize</span> <span class=kt>int32</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The first method will write all the necessary information about the disks in the <code>DiskData</code> structure. <code>Gopsutil</code> will be used to retrieve information from the system. If in a system the disk is displayed as <code>nvme</code> it needs to be brought to standard record (/dev/sda) which can be used to filter the necessary ebs volumes. But this alone will not be enough because disks on different servers can be mounted under the same name. To prevent modification of the wrong volume an instance id will be used as an additional condition in a filter. It can be obtained from the server metadata.</p><p>First I get a list of all disks using <code>disk.Partitions(false)</code>, also I create ec2client and get instanceID from metadata. These methods will be created later. Next, in cycle, i loop through all the disks and check if <code>nvme</code> is in the disk name. If yes with <code>ebsnvme</code> i get disk name in format /dev/sda. And save the result in <code>ebsDevice</code>. If not that I change a disk name from <code>xvd</code> to <code>sd</code>. This is the format required for AWS. Now I can query aws to get the volumeID. Using the <code>Usage</code> method from AWS SDK. I get disk usage and write it to the <code>DiskData</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>filterDisks</span><span class=p>()</span> <span class=p>([]</span><span class=nx>DiskData</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>parts</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>disk</span><span class=p>.</span><span class=nf>Partitions</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getEc2Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>instanceID</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getInstanceID</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>diskData</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>DiskData</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>p</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>parts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>ebsDevice</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Device</span><span class=p>,</span> <span class=s>&#34;nvme&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>volumeMapping</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ebsnvme</span><span class=p>.</span><span class=nf>ScanDevice</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>ebsDevice</span> <span class=p>=</span> <span class=nx>volumeMapping</span><span class=p>.</span><span class=nx>Name</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ebsDevice</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Replace</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Device</span><span class=p>,</span> <span class=s>&#34;xvd&#34;</span><span class=p>,</span> <span class=s>&#34;sd&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>filter</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>ec2</span><span class=p>.</span><span class=nx>DescribeVolumesInput</span><span class=p>{</span><span class=nx>Filters</span><span class=p>:</span> <span class=p>[]</span><span class=nx>types</span><span class=p>.</span><span class=nx>Filter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Name</span><span class=p>:</span> <span class=nx>aws</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;attachment.device&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Values</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>ebsDevice</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Name</span><span class=p>:</span> <span class=nx>aws</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;attachment.instance-id&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Values</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>instanceID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>volumeInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>DescribeVolumes</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>filter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>usage</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>disk</span><span class=p>.</span><span class=nf>Usage</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Mountpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>disk</span> <span class=o>:=</span> <span class=nx>DiskData</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>VolumeID</span><span class=p>:</span>   <span class=o>*</span><span class=nx>volumeInfo</span><span class=p>.</span><span class=nx>Volumes</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>VolumeId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>DeviceName</span><span class=p>:</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Device</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>MountPoint</span><span class=p>:</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Mountpoint</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>TotalUsed</span><span class=p>:</span>  <span class=nx>usage</span><span class=p>.</span><span class=nx>UsedPercent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>TotalSpace</span><span class=p>:</span> <span class=nx>usage</span><span class=p>.</span><span class=nx>Total</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>VolumeSize</span><span class=p>:</span> <span class=nx>volumeInfo</span><span class=p>.</span><span class=nx>Volumes</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>FsType</span><span class=p>:</span>     <span class=nx>p</span><span class=p>.</span><span class=nx>Fstype</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>diskData</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>diskData</span><span class=p>,</span> <span class=nx>disk</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>diskData</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>I need to create the methods used by filterDisks, starting from <code>getInstanceID</code>. This method queries the ec2 instance metadata and receives an InstanceID in response.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>getInstanceID</span><span class=p>()</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cfg</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>config</span><span class=p>.</span><span class=nf>LoadDefaultConfig</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>imds</span><span class=p>.</span><span class=nf>NewFromConfig</span><span class=p>(</span><span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>instanceID</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>GetInstanceIdentityDocument</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=o>&amp;</span><span class=nx>imds</span><span class=p>.</span><span class=nx>GetInstanceIdentityDocumentInput</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>instanceID</span><span class=p>.</span><span class=nx>InstanceID</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>getEc2Client</code> gets the region name from the metadata and returns the ec2 client.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>getEc2Client</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>ec2</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cfg</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>config</span><span class=p>.</span><span class=nf>LoadDefaultConfig</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>imds</span><span class=p>.</span><span class=nf>NewFromConfig</span><span class=p>(</span><span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>region</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>GetRegion</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=o>&amp;</span><span class=nx>imds</span><span class=p>.</span><span class=nx>GetRegionInput</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cfg</span><span class=p>.</span><span class=nx>Region</span> <span class=p>=</span> <span class=nx>region</span><span class=p>.</span><span class=nx>Region</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ec2</span><span class=p>.</span><span class=nf>NewFromConfig</span><span class=p>(</span><span class=nx>cfg</span><span class=p>),</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>What is left is to calculate what amounts of gigabytes disk should be resized.
This method converts the disk size obtained in <code>filterDisks</code> from bytes to gigabytes and determines new size of ebs volume.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>findNewSize</span><span class=p>(</span><span class=nx>oldSize</span> <span class=kt>uint64</span><span class=p>,</span> <span class=nx>increasePercent</span> <span class=kt>float64</span><span class=p>)</span> <span class=kt>int32</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>gbSize</span> <span class=o>:=</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>oldSize</span><span class=p>)</span> <span class=o>/</span> <span class=nx>math</span><span class=p>.</span><span class=nf>Pow</span><span class=p>(</span><span class=mi>1024</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>newSize</span> <span class=o>:=</span> <span class=p>((</span><span class=nx>gbSize</span> <span class=o>*</span> <span class=nx>increasePercent</span><span class=p>)</span> <span class=o>/</span> <span class=mi>100</span><span class=p>)</span> <span class=o>+</span> <span class=nx>gbSize</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>newSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The resize will take place in three steps:</p><ol><li><p>Increase the size of the ebs</p></li><li><p>Call the grow part to increase the size of the particle if it exists.</p></li><li><p>Increase the size of the file system.</p></li></ol><p>I&rsquo;ll start with the first step.
In this method, I get the ec2 client using the <code>getEc2Client</code> method and make a <code>ModifyVolume</code> request to AWS. Here it is important to filter out certain errors.
The first is <code>VolumeModificationRateExceeded</code>. AWS allows you to resize once every 6 hours, so I don&rsquo;t want the script to fail if the limit is exceeded.</p><p>The next error is <code>IncorrectModificationState</code>. After resizing the disk, its status changes to <code>Optimizing</code>, in which case I also do not want to quit, and go to the next disk.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ebsResize</span><span class=p>(</span><span class=nx>newSize</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>volumeID</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getEc2Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Starting resize of ebs volume&#34;</span><span class=p>,</span> <span class=nx>volumeID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>input</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>ec2</span><span class=p>.</span><span class=nx>ModifyVolumeInput</span><span class=p>{</span><span class=nx>VolumeId</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>volumeID</span><span class=p>,</span> <span class=nx>Size</span><span class=p>:</span> <span class=nx>newSize</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>ModifyVolume</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>input</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>ae</span> <span class=nx>smithy</span><span class=p>.</span><span class=nx>APIError</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>As</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>ae</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>switch</span> <span class=nx>ae</span><span class=p>.</span><span class=nf>ErrorCode</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s>&#34;VolumeModificationRateExceeded&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Ebs was already resized, wait for 6 hours before next resize&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>errVolumeRetryLater</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s>&#34;IncorrectModificationState&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>ae</span><span class=p>.</span><span class=nf>ErrorMessage</span><span class=p>())</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>errVolumeRetryLater</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nf>waitForEbsResize</span><span class=p>(</span><span class=nx>volumeID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Once the resize is started, I need to wait for it to complete, so I will create the following method <code>waitForEbsResize</code>.
The <code>waitForEbsResize</code> method uses the ec2 client to make a request of type <code>DescribeVolumesModifications</code> and checks whether the status of the disk is <code>modifying</code>. If yes, it waits for 15 seconds and runs the method recursively again.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>waitForEbsResize</span><span class=p>(</span><span class=nx>volumeID</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getEc2Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>input</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>ec2</span><span class=p>.</span><span class=nx>DescribeVolumesModificationsInput</span><span class=p>{</span><span class=nx>VolumeIds</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=nx>volumeID</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>	<span class=nx>status</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>DescribeVolumesModifications</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>status</span><span class=p>.</span><span class=nx>VolumesModifications</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>ModificationState</span> <span class=o>==</span> <span class=s>&#34;modifying&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Ebs modification in progress. Waiting for 15 second&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>15</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>waitForEbsResize</span><span class=p>(</span><span class=nx>volumeID</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now I can proceed to step 2 <code>growPartition</code>.</p><p>I need to determine if there is a partition, if there is no partition grow part doesn&rsquo;t need to be executed. Depending on what type of disk I will determine whether there are partitions or no. Several checks are required. The first check if there are no numbers in the device name. If they are not present then it is not partition and it is not required to do grow part. Next check for nvme devices. If there is a symbol p in the name, then it is a partition. For example <code>/dev/nvme1n1</code> - disk and <code>/dev/nvme0n1p1</code> - partition. And the last case if there is an xvd in the name of the device, this check only to filter usual ebs devices with numbers in the name. And depending on each case the growpart is executed. For ebs - <code>growpart /dev/xvdf 1</code> and for nvme - <code>growpart /dev/nvme0n1 1</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>growPartition</span><span class=p>(</span><span class=nx>partition</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Starting growpart for&#34;</span><span class=p>,</span> <span class=nx>partition</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>cmd</span> <span class=o>*</span><span class=nx>exec</span><span class=p>.</span><span class=nx>Cmd</span>
</span></span><span class=line><span class=cl>	<span class=nx>i</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>LastIndex</span><span class=p>(</span><span class=nx>partition</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>isLetter</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>MustCompile</span><span class=p>(</span><span class=s>`^/dev/+[a-zA-Z]+$`</span><span class=p>).</span><span class=nx>MatchString</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nf>isLetter</span><span class=p>(</span><span class=nx>partition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Grow partition for&#34;</span><span class=p>,</span> <span class=nx>partition</span><span class=p>,</span> <span class=s>&#34;not required&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>i</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cmd</span> <span class=p>=</span> <span class=nx>exec</span><span class=p>.</span><span class=nf>Command</span><span class=p>(</span><span class=s>&#34;growpart&#34;</span><span class=p>,</span> <span class=nx>partition</span><span class=p>[:</span><span class=nx>i</span><span class=p>],</span> <span class=nx>partition</span><span class=p>[</span><span class=nx>i</span><span class=o>+</span><span class=mi>1</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>partition</span><span class=p>,</span> <span class=s>&#34;xvd&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>re</span> <span class=o>:=</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>MustCompile</span><span class=p>(</span><span class=s>`\D+`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>m</span> <span class=o>:=</span> <span class=nx>re</span><span class=p>.</span><span class=nf>FindString</span><span class=p>(</span><span class=nx>partition</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>cmd</span> <span class=p>=</span> <span class=nx>exec</span><span class=p>.</span><span class=nf>Command</span><span class=p>(</span><span class=s>&#34;growpart&#34;</span><span class=p>,</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>partition</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=nx>m</span><span class=p>):])</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The last step is to increase the size of the file system. How the resize will take place depends on the file system.
If it is xfs then called <code>xfs_growfs</code> in other cases it is <code>resize2fs</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>fsResize</span><span class=p>(</span><span class=nx>filesystem</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>mountPoint</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>partition</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Starting system volume resize for&#34;</span><span class=p>,</span> <span class=nx>partition</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>cmd</span> <span class=o>*</span><span class=nx>exec</span><span class=p>.</span><span class=nx>Cmd</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>filesystem</span> <span class=o>==</span> <span class=s>&#34;xfs&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cmd</span> <span class=p>=</span> <span class=nx>exec</span><span class=p>.</span><span class=nf>Command</span><span class=p>(</span><span class=s>&#34;xfs_growfs&#34;</span><span class=p>,</span> <span class=s>&#34;-d&#34;</span><span class=p>,</span> <span class=nx>mountPoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cmd</span> <span class=p>=</span> <span class=nx>exec</span><span class=p>.</span><span class=nf>Command</span><span class=p>(</span><span class=s>&#34;resize2fs&#34;</span><span class=p>,</span> <span class=nx>partition</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now it remains to call all the methods in the correct order:</p><ol><li><p>Get a list of disks</p></li><li><p>Loop in a cycle on all of disks. If the condition <code>disk.TotalUsed &lt; 70</code> is false then resize not required.</p></li><li><p>Calculate the new disk size</p></li><li><p>Call ebsResize</p></li><li><p>Call growPartition</p></li><li><p>Call fsResize</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>disksInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>filterDisks</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>disk</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>disksInfo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>disk</span><span class=p>.</span><span class=nx>TotalUsed</span> <span class=p>&lt;</span> <span class=mi>70</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Resize for&#34;</span><span class=p>,</span> <span class=nx>disk</span><span class=p>.</span><span class=nx>DeviceName</span><span class=p>,</span> <span class=s>&#34;not required&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Starting resize of&#34;</span><span class=p>,</span> <span class=nx>disk</span><span class=p>.</span><span class=nx>DeviceName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>newSize</span> <span class=o>:=</span> <span class=nf>findNewSize</span><span class=p>(</span><span class=nx>disk</span><span class=p>.</span><span class=nx>TotalSpace</span><span class=p>,</span> <span class=mi>30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>ebsResize</span><span class=p>(</span><span class=nb>int32</span><span class=p>(</span><span class=nx>newSize</span><span class=p>),</span> <span class=nx>disk</span><span class=p>.</span><span class=nx>VolumeID</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>errVolumeRetryLater</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>growPartition</span><span class=p>(</span><span class=nx>disk</span><span class=p>.</span><span class=nx>DeviceName</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>fsResize</span><span class=p>(</span><span class=nx>disk</span><span class=p>.</span><span class=nx>FsType</span><span class=p>,</span> <span class=nx>disk</span><span class=p>.</span><span class=nx>MountPoint</span><span class=p>,</span> <span class=nx>disk</span><span class=p>.</span><span class=nx>DeviceName</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>After a few seconds, the disk has a new size.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://mpostument.com/tags/go/>Go</a></li><li><a href=https://mpostument.com/tags/devops/>Devops</a></li><li><a href=https://mpostument.com/tags/aws/>AWS</a></li></ul><nav class=paginav><a class=prev href=https://mpostument.com/posts/projects/ebs-autoresize/><span class=title>« Prev</span><br><span>ebs-autoresize</span>
</a><a class=next href=https://mpostument.com/posts/programming/golang/failed-asg-event-notification/><span class=title>Next »</span><br><span>Failed Asg Event Notification</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Ebs Auto Resize on x" href="https://x.com/intent/tweet/?text=Ebs%20Auto%20Resize&amp;url=https%3a%2f%2fmpostument.com%2fposts%2fprogramming%2fgolang%2febs-auto-resize%2f&amp;hashtags=Go%2cDevops%2cAWS"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ebs Auto Resize on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmpostument.com%2fposts%2fprogramming%2fgolang%2febs-auto-resize%2f&amp;title=Ebs%20Auto%20Resize&amp;summary=Ebs%20Auto%20Resize&amp;source=https%3a%2f%2fmpostument.com%2fposts%2fprogramming%2fgolang%2febs-auto-resize%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ebs Auto Resize on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmpostument.com%2fposts%2fprogramming%2fgolang%2febs-auto-resize%2f&title=Ebs%20Auto%20Resize"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ebs Auto Resize on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmpostument.com%2fposts%2fprogramming%2fgolang%2febs-auto-resize%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ebs Auto Resize on whatsapp" href="https://api.whatsapp.com/send?text=Ebs%20Auto%20Resize%20-%20https%3a%2f%2fmpostument.com%2fposts%2fprogramming%2fgolang%2febs-auto-resize%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ebs Auto Resize on telegram" href="https://telegram.me/share/url?text=Ebs%20Auto%20Resize&amp;url=https%3a%2f%2fmpostument.com%2fposts%2fprogramming%2fgolang%2febs-auto-resize%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Ebs Auto Resize on ycombinator" href="https://news.ycombinator.com/submitlink?t=Ebs%20Auto%20Resize&u=https%3a%2f%2fmpostument.com%2fposts%2fprogramming%2fgolang%2febs-auto-resize%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mpostument-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://mpostument.com/>mpostument.com</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>