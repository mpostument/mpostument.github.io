<!doctype html><html lang=en>
<head>
<title>Ebs Auto Resize :: mpostument.com</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Automatic AWS EBS resize with golang">
<meta name=keywords content="Go,Devops,AWS,Golang,Ec2,Ebs">
<meta name=robots content="noodp">
<link rel=canonical href=/2021/02/06/ebs-auto-resize/>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SBRJXS94DC"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-SBRJXS94DC',{anonymize_ip:!1})}</script>
<link rel=stylesheet href=/assets/style.css>
<link rel=stylesheet href=/assets/blue.css>
<link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=/img/favicon/blue.png>
<meta name=twitter:card content="summary">
<meta name=twitter:site content="mpostument.com">
<meta name=twitter:creator content="Maks_Postument">
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Ebs Auto Resize">
<meta property="og:description" content="Automatic AWS EBS resize with golang">
<meta property="og:url" content="/2021/02/06/ebs-auto-resize/">
<meta property="og:site_name" content="mpostument.com">
<meta property="og:image" content="https://i.imgur.com/ErqKnk5.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:section" content="Devops">
<meta property="article:section" content="Golang">
<meta property="article:section" content="AWS">
<meta property="article:published_time" content="2021-02-06 18:14:40 +0200 +0200">
<p align=center style=background-color:#23b0ff> Sign up for my <a href=https://tinyletter.com/mpostument>email newsletter</a> or use this <a href=/index.xml>RSS feed</a> to get notified of new blog posts.</p>
</head>
<body class=blue>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
mpostument.com
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/>Home</a></li>
<li><a href=/categories/>Categories</a></li>
<li><a href=/tags/>Tags</a></li>
<li><a href=/projects/>Projects</a></li>
<div class=spacer></div>
<ul class=language-selector>
<ul class=language-selector-current>
<li>English ▾</li>
</ul>
<ul class="language-selector__more hidden">
<li><a href=/>English</a></li>
<li><a href=/ua/>Ukraine</a></li>
</ul>
</ul>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/>Home</a></li>
<li><a href=/categories/>Categories</a></li>
<li><a href=/tags/>Tags</a></li>
<li><a href=/projects/>Projects</a></li>
<hr>
<li>
<a href=/>English</a>
</li>
<li>
<a href=/ua/>Ukraine</a>
</li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=/2021/02/06/ebs-auto-resize/>Ebs Auto Resize</a></h1>
<div class=post-meta>
<span class=post-date>
2021-02-06
</span>
<span class=post-author>:: Maksym Postument</span>
</div>
<span class=post-tags>
#<a href=/tags/go/>Go</a>&nbsp;
#<a href=/tags/devops/>Devops</a>&nbsp;
#<a href=/tags/aws/>AWS</a>&nbsp;
</span>
<img src=https://i.imgur.com/ErqKnk5.png class=post-cover alt="Ebs Auto Resize" title="Cover Image">
<div class=post-content><div>
<p>Hi there!</p>
<p>Today we will make a script for automatic resizing of EBS volume using golang and AWS SDK version 2.
To do this, I need to perform a few steps: get a list of volumes, filter those volumes in which the amount of free memory is less than the threshold, find the ebs id that corresponds to this volume. Resize by a specified percentage and increase the disk size on the file system.</p>
<p>I&rsquo;ll start with the structure in which all the information on the disk will be stored and specify all the necessary imports.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;context&#34;</span>
	<span style=color:#e6db74>&#34;errors&#34;</span>
	<span style=color:#e6db74>&#34;io/ioutil&#34;</span>
	<span style=color:#e6db74>&#34;log&#34;</span>
	<span style=color:#e6db74>&#34;math&#34;</span>
	<span style=color:#e6db74>&#34;net/http&#34;</span>
	<span style=color:#e6db74>&#34;os/exec&#34;</span>
	<span style=color:#e6db74>&#34;regexp&#34;</span>
	<span style=color:#e6db74>&#34;strings&#34;</span>
	<span style=color:#e6db74>&#34;time&#34;</span>

	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/aws&#34;</span>
	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/config&#34;</span>
	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/service/ec2&#34;</span>
	<span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go-v2/service/ec2/types&#34;</span>
	<span style=color:#e6db74>&#34;github.com/aws/smithy-go&#34;</span>
	<span style=color:#e6db74>&#34;github.com/mvisonneau/go-ebsnvme/pkg/ebsnvme&#34;</span>
	<span style=color:#e6db74>&#34;github.com/shirou/gopsutil/v3/disk&#34;</span>
)

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DiskData</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>VolumeID</span>   <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>DeviceName</span> <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>MountPoint</span> <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>TotalUsed</span>  <span style=color:#66d9ef>float64</span>
	<span style=color:#a6e22e>TotalSpace</span> <span style=color:#66d9ef>uint64</span>
	<span style=color:#a6e22e>FsType</span>     <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>VolumeSize</span> <span style=color:#66d9ef>int32</span>
}
}
</code></pre></div><p>The first method will write all the necessary information about the disks in the <code>DiskData</code> structure. <code>Gopsutil</code> will be used to retrieve information from the system. If in a system the disk is displayed as <code>nvme</code> it needs to be brought to standard record (/dev/sda) which can be used to filter the necessary ebs volumes. But this alone will not be enough because disks on different servers can be mounted under the same name. To prevent modification of the wrong volume an instance id will be used as an additional condition in a filter. It can be obtained from the server metadata.</p>
<p>First I get a list of all disks using <code>disk.Partitions(false)</code>, also I create ec2client and get instanceID from metadata. These methods will be created later. Next, in cycle, i loop through all the disks and check if <code>nvme</code> is in the disk name. If yes with <code>ebsnvme</code> i get disk name in format /dev/sda. And save the result in <code>ebsDevice</code>. If not that I change a disk name from <code>xvd</code> to <code>sd</code>. This is the format required for AWS. Now I can query aws to get the volumeID. Using the <code>Usage</code> method from AWS SDK. I get disk usage and write it to the <code>DiskData</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>filterDisks</span>() ([]<span style=color:#a6e22e>DiskData</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>parts</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>Partitions</span>(<span style=color:#66d9ef>false</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getEc2Client</span>()
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#a6e22e>instanceID</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getInstanceID</span>()
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#a6e22e>diskData</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>DiskData</span>{}

	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>parts</span> {
		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ebsDevice</span> <span style=color:#66d9ef>string</span>

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Device</span>, <span style=color:#e6db74>&#34;nvme&#34;</span>) {
			<span style=color:#a6e22e>volumeMapping</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ebsnvme</span>.<span style=color:#a6e22e>ScanDevice</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Device</span>)
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
			}
			<span style=color:#a6e22e>ebsDevice</span> = <span style=color:#a6e22e>volumeMapping</span>.<span style=color:#a6e22e>Name</span>
		} <span style=color:#66d9ef>else</span> {
			<span style=color:#a6e22e>ebsDevice</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Replace</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Device</span>, <span style=color:#e6db74>&#34;xvd&#34;</span>, <span style=color:#e6db74>&#34;sd&#34;</span>, <span style=color:#ae81ff>1</span>)
		}

		<span style=color:#a6e22e>filter</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ec2</span>.<span style=color:#a6e22e>DescribeVolumesInput</span>{<span style=color:#a6e22e>Filters</span>: []<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>Filter</span>{
			{
				<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;attachment.device&#34;</span>),
				<span style=color:#a6e22e>Values</span>: []<span style=color:#66d9ef>string</span>{
					<span style=color:#a6e22e>ebsDevice</span>,
				},
			},
			{
				<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;attachment.instance-id&#34;</span>),
				<span style=color:#a6e22e>Values</span>: []<span style=color:#66d9ef>string</span>{
					<span style=color:#a6e22e>instanceID</span>,
				},
			},
		},
		}

		<span style=color:#a6e22e>volumeInfo</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>DescribeVolumes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>filter</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
		}
		<span style=color:#a6e22e>usage</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>Usage</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Mountpoint</span>)
		<span style=color:#a6e22e>disk</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>DiskData</span>{
			<span style=color:#a6e22e>VolumeID</span>:   <span style=color:#f92672>*</span><span style=color:#a6e22e>volumeInfo</span>.<span style=color:#a6e22e>Volumes</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>VolumeId</span>,
			<span style=color:#a6e22e>DeviceName</span>: <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Device</span>,
			<span style=color:#a6e22e>MountPoint</span>: <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Mountpoint</span>,
			<span style=color:#a6e22e>TotalUsed</span>:  <span style=color:#a6e22e>usage</span>.<span style=color:#a6e22e>UsedPercent</span>,
			<span style=color:#a6e22e>TotalSpace</span>: <span style=color:#a6e22e>usage</span>.<span style=color:#a6e22e>Total</span>,
			<span style=color:#a6e22e>VolumeSize</span>: <span style=color:#a6e22e>volumeInfo</span>.<span style=color:#a6e22e>Volumes</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Size</span>,
			<span style=color:#a6e22e>FsType</span>:     <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Fstype</span>,
		}
		<span style=color:#a6e22e>diskData</span> = append(<span style=color:#a6e22e>diskData</span>, <span style=color:#a6e22e>disk</span>)
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>diskData</span>, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>I need to create the methods used by filterDisks, starting from <code>getInstanceID</code>. This method queries the ec2 instance metadata and receives an InstanceID in response.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getInstanceID</span>() (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LoadDefaultConfig</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>())
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>imds</span>.<span style=color:#a6e22e>NewFromConfig</span>(<span style=color:#a6e22e>cfg</span>)
	<span style=color:#a6e22e>instanceID</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>GetInstanceIdentityDocument</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>imds</span>.<span style=color:#a6e22e>GetInstanceIdentityDocumentInput</span>{})
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>instanceID</span>.<span style=color:#a6e22e>InstanceID</span>, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p><code>getEc2Client</code> gets the region name from the metadata and returns the ec2 client.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getEc2Client</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>ec2</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LoadDefaultConfig</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>())
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>imds</span>.<span style=color:#a6e22e>NewFromConfig</span>(<span style=color:#a6e22e>cfg</span>)
	<span style=color:#a6e22e>region</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>GetRegion</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>imds</span>.<span style=color:#a6e22e>GetRegionInput</span>{})
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Region</span> = <span style=color:#a6e22e>region</span>.<span style=color:#a6e22e>Region</span>
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ec2</span>.<span style=color:#a6e22e>NewFromConfig</span>(<span style=color:#a6e22e>cfg</span>), <span style=color:#a6e22e>err</span>
}
</code></pre></div><p>What is left is to calculate what amounts of gigabytes disk should be resized.
This method converts the disk size obtained in <code>filterDisks</code> from bytes to gigabytes and determines new size of ebs volume.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>findNewSize</span>(<span style=color:#a6e22e>oldSize</span> <span style=color:#66d9ef>uint64</span>, <span style=color:#a6e22e>increasePercent</span> <span style=color:#66d9ef>float64</span>) <span style=color:#66d9ef>int32</span> {
	<span style=color:#a6e22e>gbSize</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>oldSize</span>) <span style=color:#f92672>/</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Pow</span>(<span style=color:#ae81ff>1024</span>, <span style=color:#ae81ff>3</span>)
	<span style=color:#a6e22e>newSize</span> <span style=color:#f92672>:=</span> ((<span style=color:#a6e22e>gbSize</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>increasePercent</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>100</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>gbSize</span>
	<span style=color:#66d9ef>return</span> int32(<span style=color:#a6e22e>newSize</span>)
}
</code></pre></div><p>The resize will take place in three steps:</p>
<ol>
<li>
<p>Increase the size of the ebs</p>
</li>
<li>
<p>Call the grow part to increase the size of the particle if it exists.</p>
</li>
<li>
<p>Increase the size of the file system.</p>
</li>
</ol>
<p>I&rsquo;ll start with the first step.
In this method, I get the ec2 client using the <code>getEc2Client</code> method and make a <code>ModifyVolume</code> request to AWS. Here it is important to filter out certain errors.
The first is <code>VolumeModificationRateExceeded</code>. AWS allows you to resize once every 6 hours, so I don&rsquo;t want the script to fail if the limit is exceeded.</p>
<p>The next error is <code>IncorrectModificationState</code>. After resizing the disk, its status changes to <code>Optimizing</code>, in which case I also do not want to quit, and go to the next disk.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ebsResize</span>(<span style=color:#a6e22e>newSize</span> <span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>volumeID</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getEc2Client</span>()
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
	}
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting resize of ebs volume&#34;</span>, <span style=color:#a6e22e>volumeID</span>)
	<span style=color:#a6e22e>input</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ec2</span>.<span style=color:#a6e22e>ModifyVolumeInput</span>{<span style=color:#a6e22e>VolumeId</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>volumeID</span>, <span style=color:#a6e22e>Size</span>: <span style=color:#a6e22e>newSize</span>}
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>ModifyVolume</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>input</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ae</span> <span style=color:#a6e22e>smithy</span>.<span style=color:#a6e22e>APIError</span>
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>As</span>(<span style=color:#a6e22e>err</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ae</span>) {
			<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>ae</span>.<span style=color:#a6e22e>ErrorCode</span>() {
			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;VolumeModificationRateExceeded&#34;</span>:
				<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Ebs was already resized, wait for 6 hours before next resize&#34;</span>)
				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errVolumeRetryLater</span>
			<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;IncorrectModificationState&#34;</span>:
				<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>ae</span>.<span style=color:#a6e22e>ErrorMessage</span>())
				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errVolumeRetryLater</span>
			}
		} <span style=color:#66d9ef>else</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
		}
	}
	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>waitForEbsResize</span>(<span style=color:#a6e22e>volumeID</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
	}
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>Once the resize is started, I need to wait for it to complete, so I will create the following method <code>waitForEbsResize</code>.
The <code>waitForEbsResize</code> method uses the ec2 client to make a request of type <code>DescribeVolumesModifications</code> and checks whether the status of the disk is <code>modifying</code>. If yes, it waits for 15 seconds and runs the method recursively again.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>waitForEbsResize</span>(<span style=color:#a6e22e>volumeID</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getEc2Client</span>()
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
	}
	<span style=color:#a6e22e>input</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ec2</span>.<span style=color:#a6e22e>DescribeVolumesModificationsInput</span>{<span style=color:#a6e22e>VolumeIds</span>: []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>volumeID</span>}}
	<span style=color:#a6e22e>status</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>DescribeVolumesModifications</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>input</span>)

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>VolumesModifications</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>ModificationState</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;modifying&#34;</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Ebs modification in progress. Waiting for 15 second&#34;</span>)
		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>15</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>waitForEbsResize</span>(<span style=color:#a6e22e>volumeID</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
		}
	}
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>Now I can proceed to step 2 <code>growPartition</code>.</p>
<p>I need to determine if there is a partition, if there is no partition grow part doesn&rsquo;t need to be executed. Depending on what type of disk I will determine whether there are partitions or no. Several checks are required. The first check if there are no numbers in the device name. If they are not present then it is not partition and it is not required to do grow part. Next check for nvme devices. If there is a symbol p in the name, then it is a partition. For example <code>/dev/nvme1n1</code> - disk and <code>/dev/nvme0n1p1</code> - partition. And the last case if there is an xvd in the name of the device, this check only to filter usual ebs devices with numbers in the name. And depending on each case the growpart is executed. For ebs - <code>growpart /dev/xvdf 1</code> and for nvme - <code>growpart /dev/nvme0n1 1</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>growPartition</span>(<span style=color:#a6e22e>partition</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting growpart for&#34;</span>, <span style=color:#a6e22e>partition</span>)
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Cmd</span>
	<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>LastIndex</span>(<span style=color:#a6e22e>partition</span>, <span style=color:#e6db74>&#34;p&#34;</span>)
	<span style=color:#a6e22e>isLetter</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>MustCompile</span>(<span style=color:#e6db74>`^/dev/+[a-zA-Z]+$`</span>).<span style=color:#a6e22e>MatchString</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isLetter</span>(<span style=color:#a6e22e>partition</span>) {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Grow partition for&#34;</span>, <span style=color:#a6e22e>partition</span>, <span style=color:#e6db74>&#34;not required&#34;</span>)
	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
		<span style=color:#a6e22e>cmd</span> = <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;growpart&#34;</span>, <span style=color:#a6e22e>partition</span>[:<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>partition</span>[<span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>:])
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Run</span>()
	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>partition</span>, <span style=color:#e6db74>&#34;xvd&#34;</span>) {
		<span style=color:#a6e22e>re</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>MustCompile</span>(<span style=color:#e6db74>`\D+`</span>)
		<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>re</span>.<span style=color:#a6e22e>FindString</span>(<span style=color:#a6e22e>partition</span>)
		<span style=color:#a6e22e>cmd</span> = <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;growpart&#34;</span>, <span style=color:#a6e22e>m</span>, <span style=color:#a6e22e>partition</span>[len(<span style=color:#a6e22e>m</span>):])
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Run</span>()
	}
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>The last step is to increase the size of the file system. How the resize will take place depends on the file system.
If it is xfs then called <code>xfs_growfs</code> in other cases it is <code>resize2fs</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>fsResize</span>(<span style=color:#a6e22e>filesystem</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>mountPoint</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>partition</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting system volume resize for&#34;</span>, <span style=color:#a6e22e>partition</span>)
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Cmd</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>filesystem</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;xfs&#34;</span> {
		<span style=color:#a6e22e>cmd</span> = <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;xfs_growfs&#34;</span>, <span style=color:#e6db74>&#34;-d&#34;</span>, <span style=color:#a6e22e>mountPoint</span>)
	} <span style=color:#66d9ef>else</span> {
		<span style=color:#a6e22e>cmd</span> = <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;resize2fs&#34;</span>, <span style=color:#a6e22e>partition</span>)
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Run</span>()
}
</code></pre></div><p>Now it remains to call all the methods in the correct order:</p>
<ol>
<li>
<p>Get a list of disks</p>
</li>
<li>
<p>Loop in a cycle on all of disks. If the condition <code>disk.TotalUsed &lt; 70</code> is false then resize not required.</p>
</li>
<li>
<p>Calculate the new disk size</p>
</li>
<li>
<p>Call ebsResize</p>
</li>
<li>
<p>Call growPartition</p>
</li>
<li>
<p>Call fsResize</p>
</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>disksInfo</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>filterDisks</span>()
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
	}
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>disk</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>disksInfo</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>TotalUsed</span> &lt; <span style=color:#ae81ff>70</span> {
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Resize for&#34;</span>, <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>DeviceName</span>, <span style=color:#e6db74>&#34;not required&#34;</span>)
			<span style=color:#66d9ef>continue</span>
		}

		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting resize of&#34;</span>, <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>DeviceName</span>)
		<span style=color:#a6e22e>newSize</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>findNewSize</span>(<span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>TotalSpace</span>, <span style=color:#ae81ff>30</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ebsResize</span>(int32(<span style=color:#a6e22e>newSize</span>), <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>VolumeID</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>errVolumeRetryLater</span> {
			<span style=color:#66d9ef>continue</span>
		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
		}
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>growPartition</span>(<span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>DeviceName</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
		}
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fsResize</span>(<span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>FsType</span>, <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>MountPoint</span>, <span style=color:#a6e22e>disk</span>.<span style=color:#a6e22e>DeviceName</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
		}
	}
}
</code></pre></div><p>After a few seconds, the disk has a new size.</p>
</div></div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=/2021/03/06/latest-post-in-github-readme/>
<span class=button__icon>←</span>
<span class=button__text>Latest post in GitHub readme</span>
</a>
</span>
<span class="button next">
<a href=/2021/01/03/failed-asg-event-notification/>
<span class=button__text>Failed Asg Event Notification</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//mpostument-com.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=copyright>
<span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=/assets/main.js></script>
<script src=/assets/prism.js></script>
<script src=/assets/languageSelector.js></script>
</div>
</body>
</html>